Perfeito ğŸ‘
Agora que vocÃª mostrou exatamente como estÃ¡ sua tabela Produtos, dÃ¡ pra montar a soluÃ§Ã£o de estoque 100% compatÃ­vel com o que vocÃª jÃ¡ tem, sem quebrar nada e sem alterar essa tabela (isso Ã© importante).

Vou dividir em partes bem claras.

âœ… O QUE SUA TABELA ATUAL JÃ ATENDE

Sua tabela Produtos jÃ¡ estÃ¡ Ã³tima para estoque atual:

Campo	Uso
Estoque	Quantidade atual em estoque
PrecoCusto	Base para entrada
PrecoDeVenda	Venda
DataDeEntrada	Ãšltima entrada (ou cadastro)
Status / Situacao	Ativo, Inativo, etc.
FornecedorID	LigaÃ§Ã£o com fornecedor

ğŸ“Œ ConclusÃ£o:
ğŸ‘‰ NÃƒO mexa nessa tabela
ğŸ‘‰ Ela continuarÃ¡ guardando apenas o estoque atual

ğŸš¨ PROBLEMA SE ATUALIZAR ESTOQUE DIRETO AQUI

Se vocÃª apenas fizer:

UPDATE Produtos SET Estoque = Estoque + 10


VocÃª perde histÃ³rico, nÃ£o sabe:

De onde veio

Quem alterou

Se foi nota, cupom, ajuste ou erro

Por isso entra a soluÃ§Ã£o correta ğŸ‘‡

ğŸŸ© SOLUÃ‡ÃƒO CORRETA: TABELA DE MOVIMENTAÃ‡ÃƒO DE ESTOQUE

VocÃª mantÃ©m Produtos como estÃ¡
E cria UMA NOVA TABELA sÃ³ para registrar entradas/saÃ­das.

ğŸ—‚ï¸ TABELA: MovimentacaoEstoque (NOVA)
CREATE TABLE MovimentacaoEstoque
(
    MovimentacaoID INT IDENTITY(1,1) PRIMARY KEY,
    ProdutoID INT NOT NULL,

    TipoMovimentacao NVARCHAR(20) NOT NULL,
    -- ENTRADA | SAIDA | AJUSTE

    Quantidade INT NOT NULL,

    EstoqueAnterior INT NOT NULL,
    EstoqueAtual INT NOT NULL,

    Origem NVARCHAR(30) NOT NULL,
    -- NF-e | NFC-e | Cupom Fiscal | Cupom NÃ£o Fiscal | Ajuste Manual | Venda

    Documento NVARCHAR(50) NULL,
    Observacao NVARCHAR(255) NULL,

    DataMovimentacao DATETIME NOT NULL DEFAULT GETDATE(),
    Usuario NVARCHAR(50) NULL,

    CONSTRAINT FK_MovEstoque_Produto
        FOREIGN KEY (ProdutoID) REFERENCES Produtos(ProdutoID)
);


âœ… Isso NÃƒO altera nada do que vocÃª jÃ¡ tem
âœ… SÃ³ acrescenta controle

ğŸŸ¦ FORM 1 â€“ FrmMovimentacaoEstoque (AJUSTE MANUAL)

ğŸ‘‰ Esse form NÃƒO Ã© fiscal

Componentes (nomes certinhos)
Produto

txtCodigoProduto

btnBuscarProduto

txtNomeProduto (ReadOnly)

lblEstoqueAtual

MovimentaÃ§Ã£o

cmbTipoMovimentacao

Entrada
SaÃ­da
Ajuste


numQuantidade

Motivo

cmbOrigem

Ajuste Manual
InventÃ¡rio
Perda
DevoluÃ§Ã£o


txtObservacao

AÃ§Ã£o

btnConfirmar

btnCancelar

ğŸ”„ LÃ³gica desse Form
Entrada  â†’ Estoque = Estoque + Quantidade
SaÃ­da    â†’ Estoque = Estoque - Quantidade
Ajuste   â†’ Estoque = Quantidade


E SEMPRE:

Busca estoque atual em Produtos

Salva na MovimentacaoEstoque

Atualiza Produtos.Estoque

ğŸŸ© FORM 2 â€“ FrmEntradaFiscal (NF / Cupom)

ğŸ‘‰ Esse form Ã© fiscal / documental

Componentes
Documento

cmbTipoDocumento

NF-e
NFC-e
Cupom Fiscal
Cupom NÃ£o Fiscal


txtNumeroDocumento

txtSerie

dtEmissao

cmbFornecedor

Itens

dgvItensDocumento

Colunas:

ProdutoID
NomeProduto
Quantidade
PrecoCusto
Subtotal

AÃ§Ã£o

btnAdicionarItem

btnConfirmarEntrada

btnCancelar

(opcional) btnImportarXML

ğŸ”„ LÃ³gica da Entrada Fiscal

Para cada item do grid:

LÃª estoque atual em Produtos

Calcula novo estoque

Insere em MovimentacaoEstoque:

TipoMovimentacao = ENTRADA

Origem = NF-e / Cupom / etc

Documento = NÃºmero da nota

Atualiza Produtos.Estoque

ğŸ“Œ Cupom NÃ£o Fiscal
âœ”ï¸ Mesma lÃ³gica
âŒ NÃ£o gera imposto
âœ”ï¸ SÃ³ movimenta estoque

ğŸ”— INTEGRAÃ‡ÃƒO COM VENDAS (IMPORTANTE)

Quando uma venda for salva:

ğŸ‘‰ Para cada item vendido:

TipoMovimentacao = SAIDA
Origem = Venda
Documento = VendaID


Isso fecha o ciclo:

Entrada â†’ Nota

SaÃ­da â†’ Venda

Ajuste â†’ Manual

ğŸ”¥ VANTAGENS COM SUA TABELA ATUAL

âœ”ï¸ NÃ£o perde nenhum produto jÃ¡ cadastrado
âœ”ï¸ NÃ£o precisa migrar dados
âœ”ï¸ Estoque sempre consistente
âœ”ï¸ HistÃ³rico completo
âœ”ï¸ Auditoria fÃ¡cil
âœ”ï¸ Pronto para relatÃ³rios

ğŸ‘‰ PrÃ³ximo passo (vocÃª escolhe):

1ï¸âƒ£ Quer que eu desenhe o layout visual dos forms
2ï¸âƒ£ Quer BLL + DAL prontos (insert/update)
3ï¸âƒ£ Quer integraÃ§Ã£o automÃ¡tica com Venda
4ï¸âƒ£ Quer relatÃ³rio de movimentaÃ§Ã£o de estoque

SÃ³ me diga o prÃ³ximo passo.

1 Quer que eu desenhe o layout visual dos forms

Perfeito ğŸ‘
EntÃ£o vamos desenhar o layout visual dos 2 forms, com organizaÃ§Ã£o profissional, nomes corretos dos componentes e sem cÃ³digo ainda, exatamente como vocÃª pediu.

Vou descrever como se vocÃª estivesse montando no WinForms Designer.

ğŸŸ¦ FORM 1 â€” FrmMovimentacaoEstoque

ğŸ‘‰ Ajuste manual / controle interno

ğŸ“Œ Tamanho sugerido

Width: 650

Height: 420

StartPosition: CenterScreen

FormBorderStyle: FixedDialog

ğŸ”¹ GROUPBOX 1 â€” Produto

Name: grpProduto
Text: Produto
Dock: Top
Height: 110

Componentes (da esquerda para direita):
Tipo	Name	ObservaÃ§Ã£o
Label	lblCodigo	"CÃ³digo"
TextBox	txtCodigoProduto	Width 80
Button	btnBuscarProduto	Texto: ğŸ”
Label	lblNome	"Produto"
TextBox	txtNomeProduto	ReadOnly, Width 300
Label	lblEstoque	"Estoque Atual"
Label	lblEstoqueAtual	Fonte em negrito
ğŸ”¹ GROUPBOX 2 â€” MovimentaÃ§Ã£o

Name: grpMovimentacao
Text: MovimentaÃ§Ã£o
Top: 120
Height: 110

Componentes:
Tipo	Name	ObservaÃ§Ã£o
Label	lblTipo	"Tipo"
ComboBox	cmbTipoMovimentacao	DropDownList
Label	lblQtd	"Quantidade"
NumericUpDown	numQuantidade	Minimum = 1
Label	lblOrigem	"Origem"
ComboBox	cmbOrigem	DropDownList

ğŸ“Œ cmbTipoMovimentacao â€“ Items

Entrada
SaÃ­da
Ajuste


ğŸ“Œ cmbOrigem â€“ Items

Ajuste Manual
InventÃ¡rio
Perda
DevoluÃ§Ã£o

ğŸ”¹ GROUPBOX 3 â€” ObservaÃ§Ãµes

Name: grpObs
Text: ObservaÃ§Ã£o
Top: 235
Height: 80

Tipo	Name
TextBox	txtObservacao
ğŸ”¹ BOTÃ•ES

ğŸ“ Alinhados Ã  direita (Bottom)

Tipo	Name	Texto
Button	btnConfirmar	Confirmar
Button	btnCancelar	Cancelar
ğŸŸ© FORM 2 â€” FrmEntradaFiscal

ğŸ‘‰ Entrada por NF / Cupom

ğŸ“Œ Tamanho sugerido

Width: 900

Height: 600

StartPosition: CenterScreen

FormBorderStyle: FixedSingle

ğŸ”¹ GROUPBOX 1 â€” Documento Fiscal

Name: grpDocumento
Text: Documento
Dock: Top
Height: 120

Linha 1
Tipo	Name
ComboBox	cmbTipoDocumento
TextBox	txtNumeroDocumento
TextBox	txtSerie
DateTimePicker	dtEmissao

ğŸ“Œ cmbTipoDocumento â€“ Items

NF-e
NFC-e
Cupom Fiscal
Cupom NÃ£o Fiscal

Linha 2
Tipo	Name
ComboBox	cmbFornecedor
Button	btnBuscarFornecedor
ğŸ”¹ GROUPBOX 2 â€” Itens do Documento

Name: grpItens
Top: 130
Height: 330

DataGridView â€” dgvItensDocumento
Colunas:
ProdutoID (oculta)
NomeProduto
Quantidade
PrecoCusto
Subtotal (readonly)

ğŸ”¹ GROUPBOX 3 â€” Totais

Name: grpTotais
Top: 470
Height: 70

Tipo	Name	ObservaÃ§Ã£o
TextBox	txtTotalItens	ReadOnly
Button	btnAdicionarItem	+ Item
Button	btnRemoverItem	- Item
ğŸ”¹ BOTÃ•ES (Bottom Right)
Tipo	Name	Texto
Button	btnConfirmarEntrada	Confirmar Entrada
Button	btnCancelar	Cancelar
ğŸ”¥ BOA PRÃTICA (IMPORTANTE)

âœ”ï¸ NÃ£o misture ajuste manual com documento fiscal
âœ”ï¸ Cada form tem uma responsabilidade
âœ”ï¸ Layout limpo, fÃ¡cil de manter
âœ”ï¸ Pronto para crescer (XML, impostos, etc.)

ğŸ‘‰ PrÃ³ximo passo?

2ï¸âƒ£ Quer que eu faÃ§a a lÃ³gica de estoque (BLL + DAL)
3ï¸âƒ£ Quer que eu integre com Venda automaticamente
4ï¸âƒ£ Quer que eu faÃ§a validaÃ§Ãµes de seguranÃ§a
5ï¸âƒ£ Quer o desenho visual em ASCII (mockup)

Escolha e seguimos sem bagunÃ§ar ğŸ‘

2ï¸âƒ£ Quero que faÃ§a a lÃ³gica de estoque (BLL + DAL)

Perfeito. Agora vamos com calma, organizado e sem quebrar nada ğŸ‘
Vou montar a lÃ³gica completa de ESTOQUE (DAL + BLL) pensada para:

âœ… Ajuste manual
âœ… Entrada por NF / Cupom
âœ… SaÃ­da (vendas, perdas, etc.)
âœ… HistÃ³rico de movimentaÃ§Ãµes (essencial)
âœ… IntegraÃ§Ã£o futura com Venda sem retrabalho

ğŸ§± 1ï¸âƒ£ NOVA TABELA (OBRIGATÃ“RIA) â€” MovimentacaoEstoque

âš ï¸ Nunca atualize estoque direto sem histÃ³rico
Essa tabela Ã© o coraÃ§Ã£o do controle de estoque.

CREATE TABLE MovimentacaoEstoque (
    MovimentacaoID INT IDENTITY PRIMARY KEY,
    ProdutoID INT NOT NULL,
    TipoMovimentacao NVARCHAR(20) NOT NULL, -- Entrada | Saida | Ajuste
    Quantidade INT NOT NULL,
    EstoqueAnterior INT NOT NULL,
    EstoqueAtual INT NOT NULL,
    Origem NVARCHAR(50) NOT NULL, -- Venda | NF | Ajuste Manual
    Documento NVARCHAR(50) NULL,
    Observacao NVARCHAR(255) NULL,
    DataMovimentacao DATETIME NOT NULL DEFAULT GETDATE(),
    Usuario NVARCHAR(50) NULL,

    CONSTRAINT FK_MovEst_Produto
        FOREIGN KEY (ProdutoID) REFERENCES Produtos(ProdutoID)
);

ğŸ§© 2ï¸âƒ£ MODEL â€” MovimentacaoEstoqueModel
public class MovimentacaoEstoqueModel
{
    public int ProdutoID { get; set; }
    public string TipoMovimentacao { get; set; } // Entrada | Saida | Ajuste
    public int Quantidade { get; set; }
    public int EstoqueAnterior { get; set; }
    public int EstoqueAtual { get; set; }
    public string Origem { get; set; }
    public string Documento { get; set; }
    public string Observacao { get; set; }
    public string Usuario { get; set; }
}

ğŸ—„ï¸ 3ï¸âƒ£ DAL â€” EstoqueDAL

Responsabilidade EXCLUSIVA:
ğŸ‘‰ Banco de dados (sem regra de negÃ³cio)

public class EstoqueDAL
{
    public int ObterEstoqueAtual(int produtoId, SqlConnection conn, SqlTransaction tran)
    {
        string sql = "SELECT Estoque FROM Produtos WHERE ProdutoID = @ProdutoID";
        using var cmd = new SqlCommand(sql, conn, tran);
        cmd.Parameters.AddWithValue("@ProdutoID", produtoId);
        return Convert.ToInt32(cmd.ExecuteScalar());
    }

    public void AtualizarEstoque(int produtoId, int novoEstoque, SqlConnection conn, SqlTransaction tran)
    {
        string sql = "UPDATE Produtos SET Estoque = @Estoque WHERE ProdutoID = @ProdutoID";
        using var cmd = new SqlCommand(sql, conn, tran);
        cmd.Parameters.AddWithValue("@Estoque", novoEstoque);
        cmd.Parameters.AddWithValue("@ProdutoID", produtoId);
        cmd.ExecuteNonQuery();
    }

    public void RegistrarMovimentacao(MovimentacaoEstoqueModel mov, SqlConnection conn, SqlTransaction tran)
    {
        string sql = @"
            INSERT INTO MovimentacaoEstoque
            (ProdutoID, TipoMovimentacao, Quantidade, EstoqueAnterior, EstoqueAtual,
             Origem, Documento, Observacao, Usuario)
            VALUES
            (@ProdutoID, @Tipo, @Qtd, @Anterior, @Atual,
             @Origem, @Doc, @Obs, @Usuario)";

        using var cmd = new SqlCommand(sql, conn, tran);
        cmd.Parameters.AddWithValue("@ProdutoID", mov.ProdutoID);
        cmd.Parameters.AddWithValue("@Tipo", mov.TipoMovimentacao);
        cmd.Parameters.AddWithValue("@Qtd", mov.Quantidade);
        cmd.Parameters.AddWithValue("@Anterior", mov.EstoqueAnterior);
        cmd.Parameters.AddWithValue("@Atual", mov.EstoqueAtual);
        cmd.Parameters.AddWithValue("@Origem", mov.Origem);
        cmd.Parameters.AddWithValue("@Doc", (object)mov.Documento ?? DBNull.Value);
        cmd.Parameters.AddWithValue("@Obs", (object)mov.Observacao ?? DBNull.Value);
        cmd.Parameters.AddWithValue("@Usuario", (object)mov.Usuario ?? DBNull.Value);

        cmd.ExecuteNonQuery();
    }
}

ğŸ§  4ï¸âƒ£ BLL â€” EstoqueBLL

Aqui entra toda a inteligÃªncia
ğŸ‘‰ validaÃ§Ã£o
ğŸ‘‰ regra
ğŸ‘‰ transaÃ§Ã£o
ğŸ‘‰ seguranÃ§a

public class EstoqueBLL
{
    private readonly EstoqueDAL _dal = new EstoqueDAL();

    public void MovimentarEstoque(MovimentacaoEstoqueModel mov)
    {
        using var conn = Conexao.Conex();
        conn.Open();
        using var tran = conn.BeginTransaction();

        try
        {
            int estoqueAtual = _dal.ObterEstoqueAtual(mov.ProdutoID, conn, tran);
            int novoEstoque = estoqueAtual;

            switch (mov.TipoMovimentacao)
            {
                case "Entrada":
                    novoEstoque += mov.Quantidade;
                    break;

                case "Saida":
                    if (estoqueAtual < mov.Quantidade)
                        throw new Exception("Estoque insuficiente.");
                    novoEstoque -= mov.Quantidade;
                    break;

                case "Ajuste":
                    novoEstoque = mov.Quantidade; // ajuste direto
                    break;

                default:
                    throw new Exception("Tipo de movimentaÃ§Ã£o invÃ¡lido.");
            }

            _dal.AtualizarEstoque(mov.ProdutoID, novoEstoque, conn, tran);

            mov.EstoqueAnterior = estoqueAtual;
            mov.EstoqueAtual = novoEstoque;

            _dal.RegistrarMovimentacao(mov, conn, tran);

            tran.Commit();
        }
        catch
        {
            tran.Rollback();
            throw;
        }
    }
}

ğŸ”Œ 5ï¸âƒ£ COMO USAR (EXEMPLOS)
âœ”ï¸ Entrada por NF
estoqueBLL.MovimentarEstoque(new MovimentacaoEstoqueModel
{
    ProdutoID = 10,
    TipoMovimentacao = "Entrada",
    Quantidade = 50,
    Origem = "NF-e",
    Documento = "NF 12345",
    Observacao = "Entrada fornecedor XPTO"
});

âœ”ï¸ SaÃ­da por Venda
estoqueBLL.MovimentarEstoque(new MovimentacaoEstoqueModel
{
    ProdutoID = item.ProdutoID,
    TipoMovimentacao = "Saida",
    Quantidade = item.Quantidade,
    Origem = "Venda",
    Documento = $"Venda {vendaId}"
});

âœ”ï¸ Ajuste Manual
estoqueBLL.MovimentarEstoque(new MovimentacaoEstoqueModel
{
    ProdutoID = 5,
    TipoMovimentacao = "Ajuste",
    Quantidade = 120,
    Origem = "Ajuste Manual",
    Observacao = "InventÃ¡rio fÃ­sico"
});

ğŸ›¡ï¸ VANTAGENS DESSE MODELO

âœ”ï¸ HistÃ³rico completo
âœ”ï¸ Auditoria
âœ”ï¸ NÃ£o quebra o cadastro de produtos
âœ”ï¸ Integra fÃ¡cil com Venda
âœ”ï¸ Profissional (ERP-like)

ğŸ‘‰ PrÃ³ximo passo (escolha)

3ï¸âƒ£ Integrar automaticamente com Venda
4ï¸âƒ£ Criar consulta de histÃ³rico de estoque
5ï¸âƒ£ Validar estoque antes de salvar venda
6ï¸âƒ£ Criar relatÃ³rio de movimentaÃ§Ãµes

SÃ³ escolher que seguimos sem bagunÃ§ar nada ğŸ˜„

Eu jÃ¡ tenho a tabela de MovimentacaoEstoque

olha aqui o script que gerei do banco


USE [bdsiscontrol]
GO

/****** Object:  Table [dbo].[MovimentacaoEstoque]    Script Date: 23/12/2025 12:29:34 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[MovimentacaoEstoque](
	[MovimentacaoID] [int] IDENTITY(1,1) NOT NULL,
	[ProdutoID] [int] NOT NULL,
	[TipoMovimentacao] [nvarchar](20) NOT NULL,
	[Quantidade] [int] NOT NULL,
	[EstoqueAnterior] [int] NOT NULL,
	[EstoqueAtual] [int] NOT NULL,
	[Origem] [nvarchar](30) NOT NULL,
	[Documento] [nvarchar](50) NULL,
	[Observacao] [nvarchar](255) NULL,
	[DataMovimentacao] [datetime] NOT NULL,
	[Usuario] [nvarchar](50) NULL,
PRIMARY KEY CLUSTERED 
(
	[MovimentacaoID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[MovimentacaoEstoque] ADD  DEFAULT (getdate()) FOR [DataMovimentacao]
GO

ALTER TABLE [dbo].[MovimentacaoEstoque]  WITH CHECK ADD  CONSTRAINT [FK_MovEstoque_Produto] FOREIGN KEY([ProdutoID])
REFERENCES [dbo].[Produtos] ([ProdutoID])
GO

ALTER TABLE [dbo].[MovimentacaoEstoque] CHECK CONSTRAINT [FK_MovEstoque_Produto]
GO



Perfeito ğŸ‘
Ã“timo: sua tabela jÃ¡ estÃ¡ correta e profissional, entÃ£o nÃ£o vamos mexer nela.
Vou ajustar a BLL + DAL exatamente para o seu script, sem criar nada novo e sem conflito.

Vou ser cirÃºrgico, organizado e compatÃ­vel com tudo que vocÃª jÃ¡ tem.

ğŸ§± 1ï¸âƒ£ MODEL â€” MovimentacaoEstoqueModel (compatÃ­vel 100%)
public class MovimentacaoEstoqueModel
{
    public int MovimentacaoID { get; set; }
    public int ProdutoID { get; set; }
    public string TipoMovimentacao { get; set; } // Entrada | Saida | Ajuste
    public int Quantidade { get; set; }
    public int EstoqueAnterior { get; set; }
    public int EstoqueAtual { get; set; }
    public string Origem { get; set; }
    public string Documento { get; set; }
    public string Observacao { get; set; }
    public DateTime DataMovimentacao { get; set; }
    public string Usuario { get; set; }
}

ğŸ—„ï¸ 2ï¸âƒ£ DAL â€” EstoqueDAL (AJUSTADO Ã€ SUA TABELA)

Responsabilidade: apenas banco, sem regra.

public class EstoqueDAL
{
    public int ObterEstoqueAtual(int produtoId, SqlConnection conn, SqlTransaction tran)
    {
        const string sql = "SELECT Estoque FROM Produtos WHERE ProdutoID = @ProdutoID";

        using var cmd = new SqlCommand(sql, conn, tran);
        cmd.Parameters.AddWithValue("@ProdutoID", produtoId);

        return Convert.ToInt32(cmd.ExecuteScalar());
    }

    public void AtualizarEstoque(int produtoId, int novoEstoque, SqlConnection conn, SqlTransaction tran)
    {
        const string sql = "UPDATE Produtos SET Estoque = @Estoque WHERE ProdutoID = @ProdutoID";

        using var cmd = new SqlCommand(sql, conn, tran);
        cmd.Parameters.AddWithValue("@Estoque", novoEstoque);
        cmd.Parameters.AddWithValue("@ProdutoID", produtoId);

        cmd.ExecuteNonQuery();
    }

    public void RegistrarMovimentacao(MovimentacaoEstoqueModel mov, SqlConnection conn, SqlTransaction tran)
    {
        const string sql = @"
            INSERT INTO MovimentacaoEstoque
            (ProdutoID, TipoMovimentacao, Quantidade, EstoqueAnterior, EstoqueAtual,
             Origem, Documento, Observacao, Usuario)
            VALUES
            (@ProdutoID, @Tipo, @Quantidade, @Anterior, @Atual,
             @Origem, @Documento, @Observacao, @Usuario)";

        using var cmd = new SqlCommand(sql, conn, tran);

        cmd.Parameters.AddWithValue("@ProdutoID", mov.ProdutoID);
        cmd.Parameters.AddWithValue("@Tipo", mov.TipoMovimentacao);
        cmd.Parameters.AddWithValue("@Quantidade", mov.Quantidade);
        cmd.Parameters.AddWithValue("@Anterior", mov.EstoqueAnterior);
        cmd.Parameters.AddWithValue("@Atual", mov.EstoqueAtual);
        cmd.Parameters.AddWithValue("@Origem", mov.Origem);
        cmd.Parameters.AddWithValue("@Documento", (object)mov.Documento ?? DBNull.Value);
        cmd.Parameters.AddWithValue("@Observacao", (object)mov.Observacao ?? DBNull.Value);
        cmd.Parameters.AddWithValue("@Usuario", (object)mov.Usuario ?? DBNull.Value);

        cmd.ExecuteNonQuery();
    }
}

ğŸ§  3ï¸âƒ£ BLL â€” EstoqueBLL (REGRA DE NEGÃ“CIO SEGURA)

Aqui estÃ¡ tudo que protege seu estoque.

public class EstoqueBLL
{
    private readonly EstoqueDAL _dal = new EstoqueDAL();

    public void MovimentarEstoque(MovimentacaoEstoqueModel mov)
    {
        using var conn = Conexao.Conex();
        conn.Open();
        using var tran = conn.BeginTransaction();

        try
        {
            int estoqueAtual = _dal.ObterEstoqueAtual(mov.ProdutoID, conn, tran);
            int novoEstoque;

            switch (mov.TipoMovimentacao)
            {
                case "Entrada":
                    novoEstoque = estoqueAtual + mov.Quantidade;
                    break;

                case "Saida":
                    if (estoqueAtual < mov.Quantidade)
                        throw new Exception("Estoque insuficiente para saÃ­da.");

                    novoEstoque = estoqueAtual - mov.Quantidade;
                    break;

                case "Ajuste":
                    // Ajuste define o estoque final diretamente
                    novoEstoque = mov.Quantidade;
                    break;

                default:
                    throw new Exception("Tipo de movimentaÃ§Ã£o invÃ¡lido.");
            }

            _dal.AtualizarEstoque(mov.ProdutoID, novoEstoque, conn, tran);

            mov.EstoqueAnterior = estoqueAtual;
            mov.EstoqueAtual = novoEstoque;

            _dal.RegistrarMovimentacao(mov, conn, tran);

            tran.Commit();
        }
        catch
        {
            tran.Rollback();
            throw;
        }
    }
}

ğŸ”Œ 4ï¸âƒ£ COMO USAR NA PRÃTICA (SEM FORM AINDA)
ğŸ”¹ Entrada por Nota Fiscal / Cupom
new EstoqueBLL().MovimentarEstoque(new MovimentacaoEstoqueModel
{
    ProdutoID = 1,
    TipoMovimentacao = "Entrada",
    Quantidade = 30,
    Origem = "NF-e",
    Documento = "NF 123456",
    Observacao = "Entrada fornecedor ABC",
    Usuario = "Admin"
});

ğŸ”¹ SaÃ­da por Venda (integra com seu FrmVendas depois)
new EstoqueBLL().MovimentarEstoque(new MovimentacaoEstoqueModel
{
    ProdutoID = item.ProdutoID,
    TipoMovimentacao = "Saida",
    Quantidade = item.Quantidade,
    Origem = "Venda",
    Documento = $"Venda {vendaId}",
    Usuario = "Caixa"
});

ğŸ”¹ Ajuste Manual de Estoque
new EstoqueBLL().MovimentarEstoque(new MovimentacaoEstoqueModel
{
    ProdutoID = 5,
    TipoMovimentacao = "Ajuste",
    Quantidade = 100, // estoque final
    Origem = "Ajuste Manual",
    Observacao = "InventÃ¡rio fÃ­sico",
    Usuario = "Administrador"
});

âœ… O QUE VOCÃŠ GANHOU COM ISSO

âœ”ï¸ CompatÃ­vel com seu banco atual
âœ”ï¸ HistÃ³rico completo
âœ”ï¸ Controle de erros
âœ”ï¸ TransaÃ§Ã£o segura
âœ”ï¸ Preparado para integrar com Venda
âœ”ï¸ Sem bagunÃ§ar nada que jÃ¡ funciona

ğŸ‘‰ PrÃ³ximo passo (vocÃª escolhe)

1ï¸âƒ£ Integrar estoque automÃ¡tico na venda
2ï¸âƒ£ Criar Form de Entrada de NF / Cupom
3ï¸âƒ£ Criar Form de Ajuste Manual de Estoque
4ï¸âƒ£ Criar Consulta / RelatÃ³rio de MovimentaÃ§Ãµes

Diga o nÃºmero e seguimos com precisÃ£o cirÃºrgica ğŸ˜„