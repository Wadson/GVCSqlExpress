using GVC.Helpers;
using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Data;
using System.Windows.Forms;

namespace GVC.DALL
{
    internal class CidadeDal
    {
        private const string SqlBase = @"SELECT ci.CidadeID, ci.Nome, ci.EstadoID FROM Cidade ci";

        public DataTable Listar_Cidades()
        {
            var conn = Conexao.Conex();
            try
            {
                DataTable dt = new DataTable();

                string sql = @"SELECT TOP 30 Cidade.CidadeID, Cidade.Nome, Cidade.EstadoID, Estado.Uf
                               FROM Cidade  
                               INNER JOIN Estado ON Cidade.EstadoID = Estado.EstadoID";

                using var cmd = new SqlCommand(sql, conn);
                conn.Open();
                using var reader = cmd.ExecuteReader();
                dt.Load(reader);
                return dt;
            }
            catch (Exception erro)
            {
                throw new Exception("Erro ao listar cidades: " + erro.Message);
            }
            finally
            {
                conn.Close();
            }
        }

        public void Salvar(CidadeMODEL Cidades)
        {
            var conn = Conexao.Conex();
            try
            {
                SqlCommand sqlcomando = new SqlCommand(
                    "INSERT INTO Cidade (CidadeID, Nome, EstadoID) VALUES (@CidadeID, @Nome, @EstadoID)", conn);

                sqlcomando.Parameters.AddWithValue("@CidadeID", Cidades.CidadeID);
                sqlcomando.Parameters.AddWithValue("@Nome", Cidades.Nome);
                sqlcomando.Parameters.AddWithValue("@EstadoID", Cidades.EstadoID);

                conn.Open();
                sqlcomando.ExecuteNonQuery();
            }
            catch (SqlException ex)
            {
                throw new ApplicationException(ex.ToString());
            }
            finally
            {
                conn.Close();
            }
        }

        public void Excluir(CidadeMODEL Cidades)
        {
            var conn = Conexao.Conex();
            try
            {
                SqlCommand sqlcomando = new SqlCommand("DELETE FROM Cidade WHERE CidadeID = @CidadeID", conn);
                sqlcomando.Parameters.AddWithValue("@CidadeID", Cidades.CidadeID);
                conn.Open();
                sqlcomando.ExecuteNonQuery();
            }
            catch (Exception erro)
            {
                throw erro;
            }
            finally
            {
                conn.Close();
            }
        }

        public void Atualizar(CidadeMODEL Cidades)
        {
            var conn = Conexao.Conex();
            try
            {
                SqlCommand sqlcomando = new SqlCommand(
                    "UPDATE Cidade SET Nome = @Nome, EstadoID = @EstadoID WHERE CidadeID = @CidadeID", conn);

                sqlcomando.Parameters.AddWithValue("@Nome", Cidades.Nome);
                sqlcomando.Parameters.AddWithValue("@EstadoID", Cidades.EstadoID);
                sqlcomando.Parameters.AddWithValue("@CidadeID", Cidades.CidadeID);

                conn.Open();
                sqlcomando.ExecuteNonQuery();
            }
            catch (Exception erro)
            {
                throw erro;
            }
            finally
            {
                conn.Close();
            }
        }

        public DataTable PesquisarPorNome(string nome)
        {
            var conn = Conexao.Conex();
            try
            {
                DataTable dt = new DataTable();

                string sql = @"SELECT TOP 30 Cidade.CidadeID, Cidade.Nome, Cidade.EstadoID, Estado.Uf
                               FROM Cidade 
                               INNER JOIN Estado ON Cidade.EstadoID = Estado.EstadoID 
                               WHERE Cidade.Nome LIKE @Nome";

                using var cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@Nome", $"%{nome}%");

                conn.Open();
                using var reader = cmd.ExecuteReader();
                dt.Load(reader);
                return dt;
            }
            catch (Exception ex)
            {
                Utilitario.Mensagens.Aviso("Erro ao executar a pesquisa: " + ex.Message);
                return null;
            }
            finally
            {
                conn.Close();
                conn.Dispose();
            }
        }

        public DataTable PesquisarPorCodigo(int codigo)
        {
            string sql = SqlBase + " WHERE CidadeID = @CidadeID";
            var dt = new DataTable();
            using (var conn = Conexao.Conex())
            using (var cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@CidadeID", codigo);
                conn.Open();
                using (var reader = cmd.ExecuteReader())
                {
                    dt.Load(reader);
                }
            }
            return dt;
        }

        public DataTable PesquisarPorCodigo(string nome)
        {
            var conn = Conexao.Conex();
            try
            {
                DataTable dt = new DataTable();

                string sqlconn = @"SELECT TOP 30 Cidade.CidadeID, Cidade.Nome, Cidade.EstadoID, Estado.Uf
                                   FROM Cidade 
                                   INNER JOIN Estado ON Cidade.EstadoID = Estado.EstadoID 
                                   WHERE CidadeID LIKE @CidadeID";

                using (SqlCommand cmd = new SqlCommand(sqlconn, conn))
                {
                    cmd.Parameters.AddWithValue("@CidadeID", "%" + nome + "%");
                    conn.Open();
                    using (SqlDataReader reader = cmd.ExecuteReader())
                    {
                        dt.Load(reader);
                    }
                }
                return dt;
            }
            catch (Exception ex)
            {
                Utilitario.Mensagens.Aviso("Erro ao executar a pesquisa: " + ex.Message);
                return null;
            }
            finally
            {
                if (conn.State == ConnectionState.Open)
                {
                    conn.Close();
                }
                conn.Dispose();
            }
        }

        public DataTable PesquisarGeral()
        {
            var conn = Conexao.Conex();
            try
            {
                DataTable dt = new DataTable();
                string sqlconn = @"SELECT TOP 30 Cidade.CidadeID, Cidade.Nome, Cidade.EstadoID, Estado.Uf 
                                   FROM Cidade 
                                   INNER JOIN Estado ON Cidade.EstadoID = Estado.EstadoID";

                using (SqlCommand cmd = new SqlCommand(sqlconn, conn))
                {
                    conn.Open();
                    using (SqlDataReader reader = cmd.ExecuteReader())
                    {
                        dt.Load(reader);
                    }
                }
                return dt;
            }
            catch (Exception ex)
            {
                Utilitario.Mensagens.Aviso("Erro ao executar a pesquisa: " + ex.Message);
                return null;
            }
            finally
            {
                if (conn.State == ConnectionState.Open)
                {
                    conn.Close();
                }
                conn.Dispose();
            }
        }
    }
}
﻿using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;

namespace GVC.DALL
{
    internal class ClienteDal
    {
        private const string SqlBase = @"
            SELECT
                c.ClienteID,
                c.Nome,
                c.Cpf,
                c.RG,
                c.OrgaoExpedidorRG,
                c.Cnpj,
                c.IE,
                c.Telefone,
                c.Email,
                c.Logradouro,
                c.Numero,
                c.Bairro,
                c.Cep,
                c.DataNascimento,
                c.TipoCliente,
                c.Status,
                c.Observacoes,
                c.DataUltimaCompra,
                c.LimiteCredito,
                c.DataCriacao,
                c.DataAtualizacao,
                c.UsuarioCriacao,
                c.UsuarioAtualizacao,
                c.CidadeID,
                c.IsVendedor,                
                ci.Nome AS NomeCidade,                
                e.Uf AS Estado
            FROM Clientes c
            LEFT JOIN Cidade ci ON ci.CidadeID = c.CidadeID
            LEFT JOIN Estado e ON e.EstadoID = ci.EstadoID";

        // Método auxiliar para executar SQL e retornar DataTable
        private DataTable ExecuteReaderToDataTable(string sql, params SqlParameter[] parameters)
        {
            var dt = new DataTable();
            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = new SqlCommand(sql, conn))
            {
                if (parameters != null && parameters.Length > 0)
                    cmd.Parameters.AddRange(parameters);

                conn.Open();
                using (var reader = cmd.ExecuteReader())
                {
                    dt.Load(reader);
                }
            }
            return dt;
        }

        public DataTable ListarClientes()
        {
            const string sql = SqlBase + " ORDER BY c.Nome";
            return ExecuteReaderToDataTable(sql);
        }

        public bool ClienteExiste(string? nome, string? cpf)
        {
            const string sql = @"
                SELECT TOP 1 1
                FROM Clientes
                WHERE (Nome = @Nome OR Cpf = @Cpf)";

            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@Nome", string.IsNullOrWhiteSpace(nome) ? (object)DBNull.Value : nome);
                cmd.Parameters.AddWithValue("@Cpf", string.IsNullOrWhiteSpace(cpf) ? (object)DBNull.Value : cpf);

                conn.Open();
                var result = cmd.ExecuteScalar();
                return result != null;
            }
        }

        public void SalvarCliente(ClienteMODEL cliente)
        {
            if (cliente == null) throw new ArgumentNullException(nameof(cliente));
            if (ClienteExiste(cliente.Nome, cliente.Cpf))
                throw new InvalidOperationException("Já existe um cliente com este nome ou CPF.");

            const string sql = @"
                INSERT INTO Clientes (
                  Nome, Cpf, RG, OrgaoExpedidorRG, Cnpj, IE, Telefone, Email, CidadeID,
                  Logradouro, Numero, Bairro, Cep, DataNascimento, TipoCliente, Status,
                  Observacoes, LimiteCredito, DataCriacao, DataAtualizacao, UsuarioCriacao, UsuarioAtualizacao, IsVendedor
                )
                VALUES (
                  @Nome, @Cpf, @RG, @OrgaoExpedidorRG, @Cnpj, @IE, @Telefone, @Email, @CidadeID,
                  @Logradouro, @Numero, @Bairro, @Cep, @DataNascimento, @TipoCliente, @Status,
                  @Observacoes, @LimiteCredito, @DataCriacao, @DataAtualizacao, @UsuarioCriacao, @UsuarioAtualizacao, @IsVendedor
                );
                SELECT SCOPE_IDENTITY();"; // SQL Server equivalente ao LAST_INSERT_ROWID()

            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@Nome", cliente.Nome ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Cpf", cliente.Cpf ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@RG", cliente.RG ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@OrgaoExpedidorRG", cliente.OrgaoExpedidorRG ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Cnpj", cliente.Cnpj ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@IE", cliente.IE ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Telefone", cliente.Telefone ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Email", cliente.Email ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@CidadeID", cliente.CidadeID == 0 ? (object)DBNull.Value : cliente.CidadeID);
                cmd.Parameters.AddWithValue("@Logradouro", cliente.Logradouro ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Numero", cliente.Numero ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Bairro", cliente.Bairro ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Cep", cliente.Cep ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@DataNascimento", cliente.DataNascimento);
                cmd.Parameters.AddWithValue("@TipoCliente", cliente.TipoCliente ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Status", cliente.Status);
                cmd.Parameters.AddWithValue("@Observacoes", cliente.Observacoes ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@LimiteCredito", cliente.LimiteCredito);
                cmd.Parameters.AddWithValue("@DataCriacao", cliente.DataCriacao);
                cmd.Parameters.AddWithValue("@DataAtualizacao", cliente.DataAtualizacao ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@UsuarioCriacao", cliente.UsuarioCriacao ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@UsuarioAtualizacao", cliente.UsuarioAtualizacao ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@IsVendedor", cliente.IsVendedor);


                conn.Open();
                cliente.ClienteID = Convert.ToInt32(cmd.ExecuteScalar());
            }
        }

        public void Atualizar(ClienteMODEL cliente)
        {
            const string sql = @"
                UPDATE Clientes SET
                    Nome = @Nome,
                    Cpf = @Cpf,
                    RG = @RG,
                    OrgaoExpedidorRG = @OrgaoExpedidorRG,
                    Cnpj = @Cnpj,
                    IE = @IE,
                    Telefone = @Telefone,
                    Email = @Email,
                    CidadeID = @CidadeID,
                    Logradouro = @Logradouro,
                    Numero = @Numero,
                    Bairro = @Bairro,
                    Cep = @Cep,
                    DataNascimento = @DataNascimento,
                    TipoCliente = @TipoCliente,
                    Status = @Status,
                    Observacoes = @Observacoes,
                    LimiteCredito = @LimiteCredito,
                    DataAtualizacao = @DataAtualizacao,
                    UsuarioAtualizacao = @UsuarioAtualizacao,
                    IsVendedor = @IsVendedor WHERE ClienteID = @ClienteID";

            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@ClienteID", cliente.ClienteID);
                cmd.Parameters.AddWithValue("@Nome", cliente.Nome ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Cpf", cliente.Cpf ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@RG", cliente.RG ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@OrgaoExpedidorRG", cliente.OrgaoExpedidorRG ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Cnpj", cliente.Cnpj ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@IE", cliente.IE ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Telefone", cliente.Telefone ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Email", cliente.Email ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@CidadeID", cliente.CidadeID == 0 ? (object)DBNull.Value : cliente.CidadeID);
                cmd.Parameters.AddWithValue("@Logradouro", cliente.Logradouro ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Numero", cliente.Numero ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Bairro", cliente.Bairro ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Cep", cliente.Cep ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@DataNascimento", cliente.DataNascimento);
                cmd.Parameters.AddWithValue("@TipoCliente", cliente.TipoCliente ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@Status", cliente.Status);
                cmd.Parameters.AddWithValue("@Observacoes", cliente.Observacoes ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@LimiteCredito", cliente.LimiteCredito);
                cmd.Parameters.AddWithValue("@DataAtualizacao", cliente.DataAtualizacao ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@UsuarioAtualizacao", cliente.UsuarioAtualizacao ?? (object)DBNull.Value);
                cmd.Parameters.AddWithValue("@IsVendedor", cliente.IsVendedor);


                conn.Open();
                cmd.ExecuteNonQuery();
            }
        }

        public void ExcluirCliente(int clienteID)
        {
            const string sql = "DELETE FROM Clientes WHERE ClienteID = @ClienteID";
            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@ClienteID", clienteID);
                conn.Open();
                cmd.ExecuteNonQuery();
            }
        }

        public void ExcluirCliente(ClienteMODEL cliente) => ExcluirCliente(cliente.ClienteID);

        public DataTable PesquisarPorNome(string nome)
        {
            const string sql = SqlBase + " WHERE c.Nome LIKE @Nome ORDER BY c.Nome";
            return ExecuteReaderToDataTable(sql,
                new SqlParameter("@Nome", $"%{nome?.Trim()}%"));
        }

        public DataTable PesquisarPorCodigo(int codigo)
        {
            const string sql = SqlBase + " WHERE c.ClienteID = @ClienteID";
            return ExecuteReaderToDataTable(sql,
                new SqlParameter("@ClienteID", codigo));
        }

        public DataTable ListarPorTipoDePessoa(string tipoCliente)
        {
            const string sql = SqlBase + " WHERE c.TipoCliente = @TipoCliente";
            return ExecuteReaderToDataTable(sql,
                new SqlParameter("@TipoCliente", tipoCliente));
        }

        public DataTable PesquisarGeral(string texto = "")
        {
            const string sql = SqlBase + @"
                WHERE c.Nome LIKE @Texto
                   OR c.Cpf LIKE @Texto
                   OR c.Cnpj LIKE @Texto
                   OR c.Telefone LIKE @Texto
                   OR c.Email LIKE @Texto
                   OR c.Logradouro LIKE @Texto
                   OR c.Bairro LIKE @Texto
                   OR ci.Nome LIKE @Texto
                ORDER BY c.Nome
                OFFSET 0 ROWS FETCH NEXT 100 ROWS ONLY"; // LIMIT -> OFFSET/FETCH

            var filtro = $"%{texto?.Trim() ?? ""}%";
            return ExecuteReaderToDataTable(sql,
                new SqlParameter("@Texto", filtro));
        }

        public ClienteMODEL? BuscarPorCpf(string? cpf)
        {
            const string sql = @"
                SELECT TOP 1 *
                FROM Clientes
                WHERE Cpf = @Cpf";

            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@Cpf", string.IsNullOrWhiteSpace(cpf) ? (object)DBNull.Value : cpf);
                conn.Open();
                using (var reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        return MapCliente(reader);
                    }
                }
            }
            return null;
        }

        public ClienteMODEL? BuscarPorCnpj(string? cnpj)
        {
            const string sql = @"
                SELECT TOP 1 *
                FROM Clientes
                WHERE Cnpj = @Cnpj";

            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@Cnpj", string.IsNullOrWhiteSpace(cnpj) ? (object)DBNull.Value : cnpj);
                conn.Open();
                using (var reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        return MapCliente(reader);
                    }
                }
            }
            return null;
        }

        public ClienteMODEL? BuscarPorId(int clienteID)
        {
            string sql = SqlBase + " WHERE c.ClienteID = @Id";
            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@Id", clienteID);
                conn.Open();
                using (var reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        return MapCliente(reader);
                    }
                }
            }
            return null;
        }

        // ========================= NOVA TELA DE VENDAS =========================
        public List<Cliente> Listar()
        {
            const string sql = @"SELECT ClienteID, Nome, Telefone, Cpf 
                                 FROM Clientes ORDER BY Nome";

            var lista = new List<Cliente>();
            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = new SqlCommand(sql, conn))
            {
                conn.Open();
                using (var reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        lista.Add(new Cliente
                        {
                            ClienteID = reader.GetInt32(reader.GetOrdinal("ClienteID")),
                            Nome = reader["Nome"].ToString() ?? "",
                            Telefone = reader["Telefone"].ToString() ?? "",
                            CPF = reader["Cpf"].ToString() ?? ""
                        });
                    }
                }
            }
            return lista;
        }

        // Método auxiliar para mapear ClienteMODEL a partir de SqlDataReader
        private ClienteMODEL MapCliente(SqlDataReader reader)
        {
            var cliente = new ClienteMODEL
            {
                ClienteID = reader.GetInt32(reader.GetOrdinal("ClienteID")),
                Nome = reader["Nome"].ToString() ?? "",
                Cpf = reader["Cpf"].ToString() ?? "",
                RG = reader["RG"].ToString(),
                OrgaoExpedidorRG = reader["OrgaoExpedidorRG"].ToString(),
                Cnpj = reader["Cnpj"].ToString(),
                IE = reader["IE"].ToString(),
                Telefone = reader["Telefone"].ToString(),
                Email = reader["Email"].ToString(),
                Logradouro = reader["Logradouro"].ToString(),
                Numero = reader["Numero"].ToString(),
                Bairro = reader["Bairro"].ToString(),
                Cep = reader["Cep"].ToString(),
                TipoCliente = reader["TipoCliente"].ToString(),
                Status = reader["Status"] != DBNull.Value ? Convert.ToInt64(reader["Status"]) : 0,
                Observacoes = reader["Observacoes"].ToString(),
                UsuarioCriacao = reader["UsuarioCriacao"].ToString(),
                UsuarioAtualizacao = reader["UsuarioAtualizacao"].ToString(),
                IsVendedor = reader["IsVendedor"] != DBNull.Value ? Convert.ToBoolean(reader["IsVendedor"]) : null,                
                // Adicione os demais campos conforme sua classe ClienteMODEL
            };
            return cliente;
        }
        public List<ClienteMODEL> ListarClienteDinamico(string filtro = "")
        {
            var lista = new List<ClienteMODEL>();

            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = conn.CreateCommand())
            {
                cmd.CommandText = @"
            SELECT ClienteID, Nome
            FROM Clientes
            WHERE IsVendedor = 0
              AND Status = 1
              AND Nome LIKE @filtro
            ORDER BY Nome";

                cmd.Parameters.AddWithValue("@filtro", $"%{filtro}%");

                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    while (dr.Read())
                    {
                        lista.Add(new ClienteMODEL
                        {
                            ClienteID = dr.GetInt32(0),
                            Nome = dr.GetString(1)
                        });
                    }
                }
            }

            return lista;
        }

        public List<ClienteMODEL> ListarVendedores(string filtro = "")
        {
            var lista = new List<ClienteMODEL>();

            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = conn.CreateCommand())
            {
                cmd.CommandText = @"
            SELECT ClienteID, Nome
            FROM Clientes
            WHERE IsVendedor = 1
              AND Status = 1
              AND Nome LIKE @filtro
            ORDER BY Nome";

                cmd.Parameters.AddWithValue("@filtro", $"%{filtro}%");

                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    while (dr.Read())
                    {
                        lista.Add(new ClienteMODEL
                        {
                            ClienteID = dr.GetInt32(0),
                            Nome = dr.GetString(1)
                        });
                    }
                }
            }

            return lista;
        }

    }

    // Classe simples para lista de vendas
    public class Cliente
    {
        public int ClienteID { get; set; }
        public string Nome { get; set; } = "";
        public string Telefone { get; set; } = "";
        public string CPF { get; set; } = "";
    }
}
﻿using Dapper;
using GVC.MODEL;
using System;
using System.Collections.Generic;
using System.Text;

namespace GVC.DAL
{
    public class ContasAReceberDAL
    {
        public List<ContaAReceberDTO> ListarContasAReceber(
    string tipoPesquisa,
    string nomeCliente,
    string numeroVenda,
    DateTime dataInicial,
    DateTime dataFinal,
    string statusParcela)
        {
            var sql = new StringBuilder();
            sql.Append(@"
        SELECT 
            p.ParcelaID       AS ParcelaID,
            p.VendaID         AS VendaID,
            p.NumeroParcela   AS NumeroParcela,
            c.Nome            AS NomeCliente,
            v.DataVenda       AS DataVenda,
            p.DataVencimento  AS DataVencimento,
            p.ValorParcela    AS ValorParcela,
            p.ValorRecebido   AS ValorRecebido,
            (p.ValorParcela + p.Juros + p.Multa - p.ValorRecebido) AS Saldo,
            p.Status          AS StatusParcela,
            fp.FormaPgto      AS FormaPgto,
            v.Observacoes     AS Observacoes
        FROM Parcela p
        JOIN Venda v       ON v.VendaID = p.VendaID
        JOIN Clientes c    ON c.ClienteID = v.ClienteID
        LEFT JOIN FormaPgto fp ON fp.FormaPgtoID = v.FormaPgtoID
        WHERE 1 = 1
    ");

            var param = new DynamicParameters();

            // 🔎 filtros (exatamente como você já tinha)
            switch (tipoPesquisa)
            {
                case "Nome do Cliente":
                    sql.Append(" AND c.Nome LIKE @Nome ");
                    param.Add("@Nome", $"%{nomeCliente}%");
                    break;

                case "Número da Venda":
                    sql.Append(" AND v.VendaID = @VendaID ");
                    param.Add("@VendaID", int.Parse(numeroVenda));
                    break;

                case "Data da Venda":
                    sql.Append(" AND CAST(v.DataVenda AS DATE) = @DataVenda ");
                    param.Add("@DataVenda", dataInicial.Date);
                    break;

                case "Período da Venda":
                    sql.Append(" AND v.DataVenda >= @Ini AND v.DataVenda < @Fim ");
                    param.Add("@Ini", dataInicial.Date);
                    param.Add("@Fim", dataFinal.Date.AddDays(1));
                    break;

                case "Vencimento":
                    sql.Append(" AND CAST(p.DataVencimento AS DATE) = @Venc ");
                    param.Add("@Venc", dataInicial.Date);
                    break;

                case "Período de Vencimento":
                    sql.Append(" AND p.DataVencimento >= @VencIni AND p.DataVencimento < @VencFim ");
                    param.Add("@VencIni", dataInicial.Date);
                    param.Add("@VencFim", dataFinal.Date.AddDays(1));
                    break;

                case "Status da Parcela":
                    sql.Append(" AND p.Status = @Status ");
                    param.Add("@Status", statusParcela);
                    break;
            }

            using var conn = Helpers.Conexao.Conex();

            // ✅ AQUI entra o código que você perguntou
            var lista = conn.Query<ContaAReceberDTO>(
                sql.ToString(),
                param
            ).ToList();

            return lista;
        }

    }

}﻿using GVC.MODEL;
using iTextSharp.text;
using iTextSharp.text.pdf;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Globalization;
using System.IO;

public static class CupomNaoFiscalPdf
{
    public static void Gerar(
        VendaModel venda,
        List<ItemVendaModel> itens,
        string nomeEmpresa,
        string cnpj,
        string endereco,
        string telefone
    )
    {
        string pasta = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments),
            "CuponsPDV"
        );

        if (!Directory.Exists(pasta))
            Directory.CreateDirectory(pasta);

        string arquivo = Path.Combine(
            pasta,
            $"CUPOM_{DateTime.Now:yyyyMMdd_HHmmss}.pdf"
        );

        var fonte = FontFactory.GetFont(FontFactory.COURIER, 9);

        using (FileStream fs = new FileStream(arquivo, FileMode.Create))
        {
            var doc = new Document(PageSize.A4, 20, 20, 20, 20);
            PdfWriter.GetInstance(doc, fs);
            doc.Open();

            void Linha(string texto = "")
            {
                doc.Add(new Paragraph(texto, fonte));
            }

            Linha("========================================");
            Linha(nomeEmpresa.ToUpper());
            Linha($"CNPJ: {cnpj}");
            Linha(endereco);
            Linha($"Tel: {telefone}");
            Linha("========================================");

            Linha($"DATA: {venda.DataVenda:dd/MM/yyyy}    HORA: {venda.DataVenda:HH:mm:ss}");
            Linha($"VENDA Nº: {venda.VendaID}");
            Linha("========================================");

            Linha("ITEM  DESCRIÇÃO            QTD   VL UNIT   TOTAL");
            Linha("========================================");

            int i = 1;
            foreach (var item in itens)
            {
                string desc = item.ProdutoDescricao.Length > 18
                    ? item.ProdutoDescricao.Substring(0, 18)
                    : item.ProdutoDescricao;

                Linha(
                    $"{i,-4} {desc,-18} {item.Quantidade,3} " +
                    $"{item.PrecoUnitario,8:N2} {item.Subtotal,8:N2}"
                );

                i++;
            }

            Linha("========================================");
            Linha($"TOTAL DE ITENS: {itens.Count}");
            Linha($"VALOR TOTAL: R$ {venda.ValorTotal:N2}");
            Linha("========================================");
            Linha("   Agradecemos a preferência!");
            Linha("        Volte sempre!");
            Linha("========================================");

            doc.Close();
        }

        Process.Start(new ProcessStartInfo
        {
            FileName = arquivo,
            UseShellExecute = true
        });
    }
}
﻿using Dapper;
using GVC.Helpers;
using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.DAL
{
    public class DashboardEstoqueDAL
    {
        public (decimal custo, decimal venda, decimal lucro) ObterResumo()
        {
            using var conn = Conexao.Conex();
            conn.Open();

            string sql = @" SELECT
                    ISNULL(SUM(Estoque * PrecoCusto), 0)   AS TotalCusto,
                    ISNULL(SUM(Estoque * PrecoDeVenda), 0) AS TotalVenda,
                    ISNULL(SUM((PrecoDeVenda - PrecoCusto) * Estoque), 0) AS TotalLucro
                FROM Produtos
                WHERE Status = 'Ativo'; ";

            using var cmd = new SqlCommand(sql, conn);
            using var dr = cmd.ExecuteReader();

            if (dr.Read())
            {
                return (
                    dr.GetDecimal(dr.GetOrdinal("TotalCusto")),
                    dr.GetDecimal(dr.GetOrdinal("TotalVenda")),
                    dr.GetDecimal(dr.GetOrdinal("TotalLucro"))
                );
            }

            return (0m, 0m, 0m);
        }
        public List<ProdutoLucrativo> ObterTopProdutosLucrativos(int top = 10)
        {
            using var conn = Conexao.Conex();
            conn.Open();

            string sql = @"SELECT TOP (@Top)
        ProdutoID,
        NomeProduto,
        Estoque,
        PrecoCusto,
        PrecoDeVenda,
        (PrecoDeVenda - PrecoCusto) AS LucroUnitario,
        ((PrecoDeVenda - PrecoCusto) * Estoque) AS LucroTotal
    FROM Produtos
    WHERE Status = 'Ativo'
    ORDER BY LucroTotal DESC;";

            return conn.Query<ProdutoLucrativo>(sql, new { Top = top }).ToList();
        }

        public List<ProdutoEstoqueBaixo> ObterEstoqueBaixo(int limite = 5)
        {
            using var conn = Conexao.Conex();
            conn.Open();

            string sql = @"SELECT
        ProdutoID,
        NomeProduto,
        Estoque,
        Unidade,
        Marca
    FROM Produtos
    WHERE Estoque <= @Limite
      AND Status = 'Ativo'
    ORDER BY Estoque ASC;";

            return conn.Query<ProdutoEstoqueBaixo>(sql, new { Limite = limite }).ToList();
        }
    }

}
﻿using Dapper;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.DAL
{
    public static class DataTableHelper
    {
        public static DataTable ExecuteReaderToDataTable(
            this SqlConnection conn,
            string sql,
            object? param = null)
        {
            using var reader = conn.ExecuteReader(sql, param);
            return reader.ToDataTable();
        }

        public static DataTable ToDataTable(this IDataReader reader)
        {
            var ds = new DataSet();
            ds.EnforceConstraints = false;
            var dt = new DataTable();
            ds.Tables.Add(dt);
            dt.Load(reader);
            return dt;
        }
    }
}
﻿using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Data;
using System.Data.SqlClient;

public class EmpresaDal
{
    private readonly string _connectionString;

    public EmpresaDal(string connectionString)
    {
        _connectionString = connectionString;
    }

    public void Inserir(EmpresaModel empresa)
    {
        const string sql = @"
    INSERT INTO Empresa (
        RazaoSocial, NomeFantasia, CNPJ, InscricaoEstadual, InscricaoMunicipal, CNAE,
        Logradouro, Numero, Bairro, Cep, Cidade, UF,
        Telefone, Email, Site,
        Responsavel, CertificadoDigital,
        Status,
        DataCriacao, UsuarioCriacao, Logo
    )
    VALUES (
        @RazaoSocial, @NomeFantasia, @CNPJ, @InscricaoEstadual, @InscricaoMunicipal, @CNAE,
        @Logradouro, @Numero, @Bairro, @Cep, @Cidade, @UF,
        @Telefone, @Email, @Site,
        @Responsavel, @CertificadoDigital,
        @Status,
        @DataCriacao, @UsuarioCriacao, Logo
    )";

        using (var conn = new SqlConnection(_connectionString))
        using (var cmd = new SqlCommand(sql, conn))
        {
            cmd.Parameters.AddWithValue("@RazaoSocial", empresa.RazaoSocial);
            cmd.Parameters.AddWithValue("@NomeFantasia", (object)empresa.NomeFantasia ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@CNPJ", empresa.CNPJ);
            cmd.Parameters.AddWithValue("@InscricaoEstadual", (object)empresa.InscricaoEstadual ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@InscricaoMunicipal", (object)empresa.InscricaoMunicipal ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@CNAE", (object)empresa.CNAE ?? DBNull.Value);

            cmd.Parameters.AddWithValue("@Logradouro", empresa.Logradouro);
            cmd.Parameters.AddWithValue("@Numero", (object)empresa.Numero ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Bairro", empresa.Bairro);
            cmd.Parameters.AddWithValue("@Cep", empresa.Cep);
            cmd.Parameters.AddWithValue("@Cidade", empresa.Cidade);
            cmd.Parameters.AddWithValue("@UF", empresa.UF);

            cmd.Parameters.AddWithValue("@Telefone", (object)empresa.Telefone ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Email", (object)empresa.Email ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Site", (object)empresa.Site ?? DBNull.Value);

            cmd.Parameters.AddWithValue("@Responsavel", (object)empresa.Responsavel ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@CertificadoDigital", (object)empresa.CertificadoDigital ?? DBNull.Value);

            cmd.Parameters.AddWithValue("@DataCriacao", empresa.DataCriacao);
            cmd.Parameters.AddWithValue("@UsuarioCriacao", (object)empresa.UsuarioCriacao ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Status", empresa.Status);
            cmd.Parameters.AddWithValue("@Logo", (object)empresa.Logo ?? DBNull.Value);

            conn.Open();
            cmd.ExecuteNonQuery();
        }
    }

    public EmpresaModel ObterPorId(int empresaId)
    {
        const string sql = "SELECT * FROM Empresa WHERE EmpresaID = @EmpresaID";

        using (var conn = new SqlConnection(_connectionString))
        using (var cmd = new SqlCommand(sql, conn))
        {
            cmd.Parameters.AddWithValue("@EmpresaID", empresaId);
            conn.Open();

            using (var reader = cmd.ExecuteReader())
            {
                if (reader.Read())
                {
                    return new EmpresaModel
                    {
                        EmpresaID = (int)reader["EmpresaID"],
                        RazaoSocial = reader["RazaoSocial"].ToString(),
                        NomeFantasia = reader["NomeFantasia"].ToString(),
                        CNPJ = reader["CNPJ"].ToString(),
                        InscricaoEstadual = reader["InscricaoEstadual"].ToString(),
                        InscricaoMunicipal = reader["InscricaoMunicipal"].ToString(),
                        CNAE = reader["CNAE"].ToString(),
                        Logradouro = reader["Logradouro"].ToString(),
                        Numero = reader["Numero"].ToString(),
                        Bairro = reader["Bairro"].ToString(),
                        Cep = reader["Cep"].ToString(),
                        Cidade = reader["Cidade"].ToString(),
                        UF = reader["UF"].ToString(),
                        Telefone = reader["Telefone"].ToString(),
                        Email = reader["Email"].ToString(),
                        Site = reader["Site"].ToString(),
                        Responsavel = reader["Responsavel"].ToString(),
                        CertificadoDigital = reader["CertificadoDigital"].ToString(),
                        DataCriacao = (DateTime)reader["DataCriacao"],
                        DataAtualizacao = reader["DataAtualizacao"] as DateTime?,
                        UsuarioCriacao = reader["UsuarioCriacao"].ToString(),
                        UsuarioAtualizacao = reader["UsuarioAtualizacao"].ToString(),
                        Logo = reader["Logo"] as byte[]
                    };
                }
            }
        }
        return null;
    }
    public void Excluir(int empresaId)
    {
        const string sql = @"
        UPDATE Empresa 
        SET Status = 0, DataAtualizacao = GETDATE() 
        WHERE EmpresaID = @EmpresaID";

        using (var conn = new SqlConnection(_connectionString))
        using (var cmd = new SqlCommand(sql, conn))
        {
            cmd.Parameters.AddWithValue("@EmpresaID", empresaId);
            conn.Open();
            cmd.ExecuteNonQuery();
        }
    }



    public void Atualizar(EmpresaModel empresa)
    {
        const string sql = @"
    UPDATE Empresa SET
        RazaoSocial = @RazaoSocial,
        NomeFantasia = @NomeFantasia,
        CNPJ = @CNPJ,
        InscricaoEstadual = @InscricaoEstadual,
        InscricaoMunicipal = @InscricaoMunicipal,
        CNAE = @CNAE,
        Logradouro = @Logradouro,
        Numero = @Numero,
        Bairro = @Bairro,
        Cep = @Cep,
        Cidade = @Cidade,
        UF = @UF,
        Telefone = @Telefone,
        Email = @Email,
        Site = @Site,
        Responsavel = @Responsavel,
        CertificadoDigital = @CertificadoDigital,
        Status = @Status,
        DataAtualizacao = @DataAtualizacao,
        UsuarioAtualizacao = @UsuarioAtualizacao, Logo = @Logo
    WHERE EmpresaID = @EmpresaID";

        


        using (var conn = new SqlConnection(_connectionString))
        using (var cmd = new SqlCommand(sql, conn))
        {
            cmd.Parameters.AddWithValue("@EmpresaID", empresa.EmpresaID);
            cmd.Parameters.AddWithValue("@RazaoSocial", empresa.RazaoSocial);
            cmd.Parameters.AddWithValue("@NomeFantasia", (object)empresa.NomeFantasia ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@CNPJ", empresa.CNPJ);
            cmd.Parameters.AddWithValue("@InscricaoEstadual", (object)empresa.InscricaoEstadual ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@InscricaoMunicipal", (object)empresa.InscricaoMunicipal ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@CNAE", (object)empresa.CNAE ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Logradouro", empresa.Logradouro);
            cmd.Parameters.AddWithValue("@Numero", (object)empresa.Numero ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Bairro", empresa.Bairro);
            cmd.Parameters.AddWithValue("@Cep", empresa.Cep);
            cmd.Parameters.AddWithValue("@Cidade", empresa.Cidade);
            cmd.Parameters.AddWithValue("@UF", empresa.UF);
            cmd.Parameters.AddWithValue("@Telefone", (object)empresa.Telefone ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Email", (object)empresa.Email ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Site", (object)empresa.Site ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Responsavel", (object)empresa.Responsavel ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@CertificadoDigital", (object)empresa.CertificadoDigital ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@DataAtualizacao", empresa.DataAtualizacao ?? (object)DBNull.Value);
            cmd.Parameters.AddWithValue("@UsuarioAtualizacao", (object)empresa.UsuarioAtualizacao ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Status", empresa.Status);
            cmd.Parameters.AddWithValue("@Logo", (object)empresa.Logo ?? DBNull.Value);
            conn.Open();
            cmd.ExecuteNonQuery();
        }

    }
}

﻿using Dapper;
using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;


namespace GVC.DALL
{
    internal class EstadoDal
    {
        // ================== LISTAR TODOS ==================
        public DataTable Listar()
        {
            const string sql = "SELECT EstadoID, Nome, Uf FROM Estado ORDER BY Nome";

            using var conn = GVC.Helpers.Conexao.Conex();
            var dt = new DataTable();
            dt.Load(conn.ExecuteReader(sql));
            return dt;
        }
        // ================== LISTAR COMO LISTA TIPADA (recomendado para ComboBox, etc) ==================
        public List<EstadoMODEL> ListarTodos()
        {
            const string sql = "SELECT EstadoID, Nome AS Nome, Uf AS UF FROM Estado ORDER BY Nome";

            using var conn = GVC.Helpers.Conexao.Conex();
            return conn.Query<EstadoMODEL>(sql).AsList();
        }
        // ================== SALVAR (INSERT) ==================
        public void Salvar(EstadoMODEL estado)
        {
            const string sql = @" INSERT INTO Estado (EstadoID, Nome, Uf) VALUES (@EstadoID, @Nome, @UF)";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Execute(sql, estado);
        }
        // ================== ATUALIZAR ==================
        public void Atualizar(EstadoMODEL estado)
        {
            const string sql = @" UPDATE Estado SET Nome = @Nome, Uf = @UF WHERE EstadoID = @EstadoID";
            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Execute(sql, estado);
        }
        // ================== EXCLUIR ==================
        public void Excluir(int EstadoID)
        {
            const string sql = "DELETE FROM Estado WHERE EstadoID = @EstadoID";
            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Execute(sql, new { EstadoID = EstadoID });
        }
        // Ou se preferir passar o objeto inteiro:
        public void Excluir(EstadoMODEL estado) => Excluir(estado.EstadoID);
        // ================== PESQUISAR POR NOME ==================
        public DataTable PesquisarPorNome(string nome)
        {
            const string sql = @" SELECT EstadoID, Nome, Uf FROM Estado WHERE Nome LIKE @Nome ORDER BY Nome LIMIT 50";

            using var conn = GVC.Helpers.Conexao.Conex();
            var dt = new DataTable();
            dt.Load(conn.ExecuteReader(sql, new { Nome = $"%{nome}%" }));
            return dt;
        }
 
        public DataTable PesquisarPorCodigo(int codigo)
        {
            const string sql = "SELECT EstadoID, Nome, Uf FROM Estado WHERE EstadoID = @EstadoID";
            using var conn = GVC.Helpers.Conexao.Conex();
            var dt = new DataTable();
            dt.Load(conn.ExecuteReader(sql, new { EstadoID = codigo }));
            return dt;
        }
        // ================== BUSCAR POR ID (retorna objeto) ==================
        public EstadoMODEL? BuscarPorId(int id)
        {
            const string sql = "SELECT EstadoID, Nome AS Nome, Uf AS UF FROM Estado WHERE EstadoID = @Id";
            using var conn = GVC.Helpers.Conexao.Conex();
            return conn.QueryFirstOrDefault<EstadoMODEL>(sql, new { Id = id });
        }

    }
}
﻿using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.DAL
{
    public class EstoqueDAL
    {
        public int ObterEstoqueAtual(int produtoId, SqlConnection conn, SqlTransaction tran)
        {
            const string sql = "SELECT Estoque FROM Produtos WHERE ProdutoID = @ProdutoID";

            using var cmd = new SqlCommand(sql, conn, tran);
            cmd.Parameters.AddWithValue("@ProdutoID", produtoId);

            return Convert.ToInt32(cmd.ExecuteScalar());
        }

        public void AtualizarEstoque(int produtoId, int novoEstoque, SqlConnection conn, SqlTransaction tran)
        {
            const string sql = "UPDATE Produtos SET Estoque = @Estoque WHERE ProdutoID = @ProdutoID";

            using var cmd = new SqlCommand(sql, conn, tran);
            cmd.Parameters.AddWithValue("@Estoque", novoEstoque);
            cmd.Parameters.AddWithValue("@ProdutoID", produtoId);

            cmd.ExecuteNonQuery();
        }

        public void RegistrarMovimentacao(MovimentacaoEstoqueModel mov, SqlConnection conn, SqlTransaction tran)
        {
            const string sql = @"
            INSERT INTO MovimentacaoEstoque
            (ProdutoID, TipoMovimentacao, Quantidade, EstoqueAnterior, EstoqueAtual,
             Origem, Documento, Observacao, Usuario)
            VALUES
            (@ProdutoID, @Tipo, @Quantidade, @Anterior, @Atual,
             @Origem, @Documento, @Observacao, @Usuario)";

            using var cmd = new SqlCommand(sql, conn, tran);

            cmd.Parameters.AddWithValue("@ProdutoID", mov.ProdutoID);
            cmd.Parameters.AddWithValue("@Tipo", mov.TipoMovimentacao);
            cmd.Parameters.AddWithValue("@Quantidade", mov.Quantidade);
            cmd.Parameters.AddWithValue("@Anterior", mov.EstoqueAnterior);
            cmd.Parameters.AddWithValue("@Atual", mov.EstoqueAtual);
            cmd.Parameters.AddWithValue("@Origem", mov.Origem);
            cmd.Parameters.AddWithValue("@Documento", (object)mov.Documento ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Observacao", (object)mov.Observacao ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@Usuario", (object)mov.Usuario ?? DBNull.Value);

            cmd.ExecuteNonQuery();
        }
    }

}
﻿using Dapper;
using GVC.DAL;
using GVC.Helpers;
using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System.Data;

namespace GVC.DALL
{
    internal class FornecedorDal
    {
        private const string SqlBase = @"
        SELECT
            f.FornecedorID,
            f.Nome,
            f.Cnpj,
            f.IE,
            f.Telefone,
            f.Email,
            f.Logradouro,
            f.Numero,
            f.Bairro,
            f.Cep,
            f.DataCriacao,
            f.Observacoes,
            f.CidadeID,
            ci.Nome AS NomeCidade,
            e.Uf AS Estado
        FROM Fornecedor f
        LEFT JOIN Cidade ci ON ci.CidadeID = f.CidadeID
        LEFT JOIN Estado e ON e.EstadoID = ci.EstadoID";

        public DataTable ListarFornecedores()
        {
            const string sql = SqlBase + " ORDER BY f.Nome";
            using var conn = Conexao.Conex();
            return conn.ExecuteReaderToDataTable(sql);
        }

        public bool FornecedorExiste(string? nome, string? cnpj)
        {
            const string sql = @"
        SELECT TOP 1 1
        FROM Fornecedor
        WHERE (Nome = @Nome OR Cnpj = @Cnpj);";

            var p = new
            {
                Nome = string.IsNullOrWhiteSpace(nome) ? null : nome,
                Cnpj = string.IsNullOrWhiteSpace(cnpj) ? null : cnpj
            };

            using var conn = Conexao.Conex();
            return conn.ExecuteScalar<int?>(sql, p) != null;
        }

        public void SalvarFornecedor(FornecedorModel fornecedor)
        {
            if (fornecedor == null) throw new ArgumentNullException(nameof(fornecedor));
            if (FornecedorExiste(fornecedor.Nome, fornecedor.Cnpj))
                throw new InvalidOperationException("Já existe um fornecedor com este nome ou CNPJ.");

            const string sql = @"
INSERT INTO Fornecedor (
  Nome, Cnpj, IE, Telefone, Email, CidadeID,
  Logradouro, Numero, Bairro, Cep, DataCriacao, Observacoes
)
VALUES (
  @Nome, @Cnpj, @IE, @Telefone, @Email, @CidadeID,
  @Logradouro, @Numero, @Bairro, @Cep, @DataCriacao, @Observacoes
);
SELECT SCOPE_IDENTITY();";   // ✅ SQL Server

            string? NullIfEmpty(string? s) => string.IsNullOrWhiteSpace(s) ? null : s;

            var p = new
            {
                Nome = NullIfEmpty(fornecedor.Nome),
                Cnpj = NullIfEmpty(fornecedor.Cnpj),
                IE = NullIfEmpty(fornecedor.IE),
                Telefone = NullIfEmpty(fornecedor.Telefone),
                Email = NullIfEmpty(fornecedor.Email),
                CidadeID = fornecedor.CidadeID,
                Logradouro = NullIfEmpty(fornecedor.Logradouro),
                Numero = NullIfEmpty(fornecedor.Numero),
                Bairro = NullIfEmpty(fornecedor.Bairro),
                Cep = NullIfEmpty(fornecedor.Cep),
                DataCriacao = fornecedor.DataCriacao ?? DateTime.Now,
                Observacoes = NullIfEmpty(fornecedor.Observacoes)
            };

            using var conn = Conexao.Conex();
            fornecedor.FornecedorID = (int)conn.QuerySingle<int>(sql, p);
        }

        public void Atualizar(FornecedorModel fornecedor)
        {
            const string sql = @"
            UPDATE Fornecedor SET
                Nome = @Nome,
                Cnpj = @Cnpj,
                IE = @IE,
                Telefone = @Telefone,
                Email = @Email,
                CidadeID = @CidadeID,
                Logradouro = @Logradouro,
                Numero = @Numero,
                Bairro = @Bairro,
                Cep = @Cep,
                Observacoes = @Observacoes,
                DataCriacao = @DataCriacao
            WHERE FornecedorID = @FornecedorID";

            using var conn = Conexao.Conex();
            conn.Execute(sql, fornecedor);
        }

        public void ExcluirFornecedor(int fornecedorID)
        {
            const string sql = "DELETE FROM Fornecedor WHERE FornecedorID = @FornecedorID";
            using var conn = Conexao.Conex();
            conn.Execute(sql, new { FornecedorID = fornecedorID });
        }

        public void ExcluirFornecedor(FornecedorModel fornecedor) => ExcluirFornecedor((int)fornecedor.FornecedorID);

        public DataTable PesquisarPorNome(string nome)
        {
            const string sql = SqlBase + " WHERE f.Nome LIKE @Nome ORDER BY f.Nome";
            using var conn = Conexao.Conex();
            return conn.ExecuteReaderToDataTable(sql, new { Nome = $"%{nome?.Trim()}%" });
        }

        public DataTable PesquisarPorCodigo(int codigo)
        {
            const string sql = SqlBase + " WHERE f.FornecedorID = @FornecedorID";
            using var conn = Conexao.Conex();
            return conn.ExecuteReaderToDataTable(sql, new { FornecedorID = codigo });
        }

        public DataTable PesquisarGeral(string texto = "")
        {
            const string sql = SqlBase + @"
            WHERE f.Nome LIKE @Texto
               OR f.Cnpj LIKE @Texto
               OR f.Telefone LIKE @Texto
               OR f.Email LIKE @Texto
               OR f.Logradouro LIKE @Texto
               OR f.Bairro LIKE @Texto
               OR ci.Nome LIKE @Texto
            ORDER BY f.Nome
            OFFSET 0 ROWS FETCH NEXT 100 ROWS ONLY";  // ✅ SQL Server

            var filtro = $"%{texto?.Trim() ?? ""}%";
            using var conn = Conexao.Conex();
            return conn.ExecuteReaderToDataTable(sql, new { Texto = filtro });
        }

        public FornecedorModel? BuscarPorCnpj(string? cnpj)
        {
            const string sql = @"
            SELECT TOP 1 *
            FROM Fornecedor
            WHERE Cnpj = @Cnpj;";   // ✅ SQL Server

            var p = new { Cnpj = string.IsNullOrWhiteSpace(cnpj) ? null : cnpj };

            using var conn = Conexao.Conex();
            return conn.QueryFirstOrDefault<FornecedorModel>(sql, p);
        }

        public FornecedorModel? BuscarPorId(int fornecedorID)
        {
            const string sql = SqlBase + " WHERE f.FornecedorID = @Id";
            using var conn = Conexao.Conex();
            return conn.QueryFirstOrDefault<FornecedorModel>(sql, new { Id = fornecedorID });
        }

        public List<FornecedorModel> Listar()
        {
            const string sql = @"SELECT FornecedorID, Nome, Telefone, Cnpj 
                 FROM Fornecedor ORDER BY Nome";

            using var conn = Conexao.Conex();
            return conn.Query<FornecedorModel>(sql).ToList();
        }
    }
}
﻿using Dapper;
using Microsoft.Data.SqlClient;
using System.Collections.Generic;
using System.Linq;

namespace GVC.DALL
{
    internal class HistoricoProdutoDal
    {
        // INSERT - Inserir novo histórico de preço
        public void InserirHistorico(BLL.HistoricoPrecoBLL historico)
        {
            const string sql = @"INSERT INTO HistoricoPreco (ProdutoID, DataRegistro, PrecoCusto, Lucro, PrecoVenda) 
            VALUES (@ProdutoID, @DataRegistro, @PrecoCusto, @Lucro, @PrecoVenda)";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Execute(sql, historico);
        }

        // SELECT - Obter todo o histórico de um produto (mais recente primeiro)
        public List<BLL.HistoricoPrecoBLL> ObterHistoricoPorProduto(int produtoID)
        {
            const string sql = @"
            SELECT HistoricoID,
                   ProdutoID,
                   DataRegistro,
                   PrecoCusto,
                   Lucro,
                   PrecoVenda
            FROM HistoricoPreco 
            WHERE ProdutoID = @ProdutoID 
            ORDER BY DataRegistro DESC";

            using var conn = GVC.Helpers.Conexao.Conex();
            return conn.Query<BLL.HistoricoPrecoBLL>(sql, new { ProdutoID = produtoID }).AsList();
        }

        // EXTRA: Último preço registrado de um produto (muito útil!)
        public BLL.HistoricoPrecoBLL? ObterUltimoPreco(int produtoID)
        {
            const string sql = @"
            SELECT TOP 1
                   HistoricoID,
                   ProdutoID,
                   DataRegistro,
                   PrecoCusto,
                   Lucro,
                   PrecoVenda
            FROM HistoricoPreco 
            WHERE ProdutoID = @ProdutoID 
            ORDER BY DataRegistro DESC";   // ✅ Ajuste para SQL Server

            using var conn = GVC.Helpers.Conexao.Conex();
            return conn.QueryFirstOrDefault<BLL.HistoricoPrecoBLL>(sql, new { ProdutoID = produtoID });
        }

        // EXTRA: Deletar histórico (opcional, se precisar)
        public void ExcluirHistorico(int historicoID)
        {
            const string sql = "DELETE FROM HistoricoPreco WHERE HistoricoID = @HistoricoID";
            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Execute(sql, new { HistoricoID = historicoID });
        }

        // EXTRA: Limpar todo histórico de um produto (útil ao excluir produto)
        public void LimparHistoricoDoProduto(int produtoID)
        {
            const string sql = "DELETE FROM HistoricoPreco WHERE ProdutoID = @ProdutoID";
            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Execute(sql, new { ProdutoID = produtoID });
        }
    }

}
﻿using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Globalization;

namespace GVC.DALL
{
    public class ItemVendaDal
    {
        // 1. ADICIONAR ITEM NA VENDA
        public void AddItemVenda(ItemVendaModel itemVenda)
        {
            string sql = @"
                INSERT INTO ItemVenda (
                    VendaID, ProdutoID, Quantidade, PrecoUnitario, Subtotal, DescontoItem
                )
                VALUES (
                    @VendaID, @ProdutoID, @Quantidade, @PrecoUnitario, @Subtotal, @DescontoItem
                )";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", itemVenda.VendaID);
            cmd.Parameters.AddWithValue("@ProdutoID", itemVenda.ProdutoID);
            cmd.Parameters.AddWithValue("@Quantidade", itemVenda.Quantidade);
            cmd.Parameters.AddWithValue("@PrecoUnitario", itemVenda.PrecoUnitario);
            cmd.Parameters.AddWithValue("@Subtotal", itemVenda.Subtotal);
            cmd.Parameters.AddWithValue("@DescontoItem", itemVenda.DescontoItem);
            cmd.ExecuteNonQuery();
        }

        // 2. ATUALIZAR ITEM DA VENDA
        public void UpdateItemVenda(ItemVendaModel itemVenda)
        {
            string sql = @"
                UPDATE ItemVenda
                SET ProdutoID = @ProdutoID,
                    Quantidade = @Quantidade,
                    PrecoUnitario = @PrecoUnitario,
                    Subtotal = @Subtotal,
                    DescontoItem = @DescontoItem
                WHERE ItemVendaID = @ItemVendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@ItemVendaID", itemVenda.ItemVendaID);
            cmd.Parameters.AddWithValue("@ProdutoID", itemVenda.ProdutoID);
            cmd.Parameters.AddWithValue("@Quantidade", itemVenda.Quantidade);
            cmd.Parameters.AddWithValue("@PrecoUnitario", itemVenda.PrecoUnitario);
            cmd.Parameters.AddWithValue("@Subtotal", itemVenda.Subtotal);
            cmd.Parameters.AddWithValue("@DescontoItem", itemVenda.DescontoItem);
            cmd.ExecuteNonQuery();
        }

        // 3. EXCLUIR ITEM POR ID
        public void DeleteItemVenda(long itemVendaId)
        {
            string sql = "DELETE FROM ItemVenda WHERE ItemVendaID = @ItemVendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@ItemVendaID", itemVendaId);
            cmd.ExecuteNonQuery();
        }

        public void Excluir(ItemVendaModel itemVenda) => DeleteItemVenda(itemVenda.ItemVendaID);

        // 4. LISTAR TODOS OS ITENS DE UMA VENDA
        public List<ItemVendaModel> ConsultarItensVenda(int vendaId)
        {
            string sql = @"
                SELECT ItemVendaID,
                       VendaID,
                       ProdutoID,
                       Quantidade,
                       PrecoUnitario,
                       Subtotal,
                       DescontoItem
                FROM ItemVenda
                WHERE VendaID = @VendaID
                ORDER BY ItemVendaID";

            var lista = new List<ItemVendaModel>();

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);

            using var reader = cmd.ExecuteReader();
            while (reader.Read())
            {
                lista.Add(new ItemVendaModel
                {
                    ItemVendaID = reader.GetInt64("ItemVendaID"),
                    VendaID = reader.GetInt64("VendaID"),
                    ProdutoID = reader.GetInt64("ProdutoID"),
                    Quantidade = reader.GetInt32("Quantidade"),
                    PrecoUnitario = reader.GetDecimal("PrecoUnitario"),
                    Subtotal = reader.GetDecimal("Subtotal"),
                    DescontoItem = reader.GetDecimal("DescontoItem")
                });
            }
            return lista;
        }

        // 5. EXCLUIR TODOS OS ITENS DE UMA VENDA
        public void ExcluirItensPorVendaID(int vendaID)
        {
            string sql = "DELETE FROM ItemVenda WHERE VendaID = @VendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaID);
            cmd.ExecuteNonQuery();
        }

        // 6. LISTAR TODOS OS ITENS (para relatórios)
        public DataTable ListarItensVenda()
        {
            string sql = "SELECT * FROM ItemVenda ORDER BY VendaID, ItemVendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            var dt = new DataTable();
            using var reader = cmd.ExecuteReader();
            dt.Load(reader);
            return dt;
        }

        // 7. BUSCAR ITEM POR ID
        public ItemVendaModel? BuscarPorId(int itemVendaId)
        {
            string sql = "SELECT * FROM ItemVenda WHERE ItemVendaID = @Id";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@Id", itemVendaId);

            using var reader = cmd.ExecuteReader();
            if (reader.Read())
            {
                return new ItemVendaModel
                {
                    ItemVendaID = reader.GetInt64("ItemVendaID"),
                    VendaID = reader.GetInt64("VendaID"),
                    ProdutoID = reader.GetInt64("ProdutoID"),
                    Quantidade = reader.GetInt32("Quantidade"),
                    PrecoUnitario = reader.GetDecimal("PrecoUnitario"),
                    Subtotal = reader.GetDecimal("Subtotal"),
                    DescontoItem = reader.GetDecimal("DescontoItem")
                };
            }
            return null;
        }

        // 8. CALCULAR TOTAL DA VENDA
        public decimal CalcularTotalVenda(int vendaId)
        {
            string sql = @"
                SELECT ISNULL(SUM((Quantidade * PrecoUnitario) - ISNULL(DescontoItem, 0)), 0)
                FROM ItemVenda
                WHERE VendaID = @VendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);
            return (decimal)cmd.ExecuteScalar();
        }

        // 9. LISTAR ITENS COM DADOS DO PRODUTO
        public DataTable ListarItensComProduto(int vendaId)
        {
            string sql = @"
                SELECT
                    iv.ItemVendaID,
                    iv.VendaID,
                    iv.ProdutoID,
                    p.NomeProduto AS ProdutoDescricao,
                    p.CodigoBarras,
                    iv.Quantidade,
                    iv.PrecoUnitario,
                    iv.Subtotal,
                    iv.DescontoItem,
                    (iv.Quantidade * iv.PrecoUnitario - ISNULL(iv.DescontoItem, 0)) AS TotalItem
                FROM ItemVenda iv
                INNER JOIN Produtos p ON iv.ProdutoID = p.ProdutoID
                WHERE iv.VendaID = @VendaID
                ORDER BY iv.ItemVendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);
            var dt = new DataTable();
            using var reader = cmd.ExecuteReader();
            dt.Load(reader);
            return dt;
        }

        // 10. LISTAR ITENS POR VENDA COM NOME DO PRODUTO
        public List<ItemVendaModel> ListarItensPorVenda(long vendaId)
        {
            string sql = @"
                SELECT
                    iv.ItemVendaID,
                    iv.VendaID,
                    iv.ProdutoID,
                    p.NomeProduto AS ProdutoDescricao,                   
                    iv.Quantidade,
                    iv.PrecoUnitario,
                    iv.Subtotal,
                    iv.DescontoItem,
                    (iv.Quantidade * iv.PrecoUnitario - ISNULL(iv.DescontoItem, 0)) AS TotalItem
                FROM ItemVenda iv
                INNER JOIN Produtos p ON iv.ProdutoID = p.ProdutoID
                WHERE iv.VendaID = @VendaID
                ORDER BY iv.ItemVendaID";           

            var itens = new List<ItemVendaModel>();

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);

            using var reader = cmd.ExecuteReader();
            while (reader.Read())
            {
                var item = new ItemVendaModel
                {
                    // ⭐⭐ MUDAR DE GetInt64 PARA GetInt32 ⭐⭐
                    ItemVendaID = reader.GetInt32("ItemVendaID"),    // GetInt32
                    VendaID = reader.GetInt32("VendaID"),            // GetInt32
                    ProdutoID = reader.GetInt32("ProdutoID"),        // GetInt32
                    Quantidade = reader.GetInt32("Quantidade"),      // Já está GetInt32

                    PrecoUnitario = reader.GetDecimal("PrecoUnitario"),
                    Subtotal = reader.IsDBNull("Subtotal") ? null : reader.GetDecimal("Subtotal"),
                    DescontoItem = reader.IsDBNull("DescontoItem") ? null : reader.GetDecimal("DescontoItem"),
                    ProdutoDescricao = reader.IsDBNull("ProdutoDescricao") ? null : reader.GetString("ProdutoDescricao")
                };
                itens.Add(item);
            }
            return itens;      
        }

        public void ExcluirPorVenda(long vendaId)
        {
            string sql = "DELETE FROM ItemVenda WHERE VendaID = @VendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);
            cmd.ExecuteNonQuery();
        }
    }
}﻿using GVC.Helpers;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.DAL
{
    public class MovimentacaoEstoqueDAL
    {
        public DataTable Consultar(
            int? produtoId,
            string tipo,
            string origem,
            DateTime inicio,
            DateTime fim)
        {
            var dt = new DataTable();

            using var conn = Conexao.Conex();
            conn.Open();

            string sql = @"
        SELECT
            me.MovimentacaoID,
            me.DataMovimentacao,
            me.TipoMovimentacao,
            me.Quantidade,
            me.EstoqueAnterior,
            me.EstoqueAtual,
            me.Origem,
            me.Documento,
            me.Observacao,
            me.Usuario,
            p.ProdutoID,
            p.NomeProduto
        FROM MovimentacaoEstoque me
        INNER JOIN Produtos p ON p.ProdutoID = me.ProdutoID
        WHERE me.DataMovimentacao BETWEEN @Inicio AND @Fim";

            if (produtoId.HasValue)
                sql += " AND me.ProdutoID = @ProdutoID";

            if (!string.IsNullOrEmpty(tipo))
                sql += " AND me.TipoMovimentacao = @Tipo";

            if (!string.IsNullOrEmpty(origem))
                sql += " AND me.Origem = @Origem";

            using var cmd = new SqlCommand(sql, conn);

            cmd.Parameters.AddWithValue("@Inicio", inicio);
            cmd.Parameters.AddWithValue("@Fim", fim);

            if (produtoId.HasValue)
                cmd.Parameters.AddWithValue("@ProdutoID", produtoId.Value);

            if (!string.IsNullOrEmpty(tipo))
                cmd.Parameters.AddWithValue("@Tipo", tipo);

            if (!string.IsNullOrEmpty(origem))
                cmd.Parameters.AddWithValue("@Origem", origem);

            using var da = new SqlDataAdapter(cmd);
            da.Fill(dt);

            return dt;
        }
    }

}
﻿using Dapper;
using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;

namespace GVC.DALL
{
    internal class PagamentoParcialDal
    {
        // 1. INSERIR PAGAMENTO PARCIAL       
        public void InserirPagamentoParcial(PagamentoParcialModel pagamentoParcial)
        {
            const string sql = @"INSERT INTO PagamentosParciais (ParcelaID, ValorPago, DataPagamento) 
                VALUES (@ParcelaID, @ValorPago, @DataPagamento)";
            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Execute(sql, pagamentoParcial);
        }

        // 2. EXCLUIR PAGAMENTO PARCIAL POR ID
        public void ExcluirPagamentoParcial(long pagamentoParcialId)
        {
            const string sql = "DELETE FROM PagamentosParciais WHERE PagamentoParcialID = @Id";
            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Execute(sql, new { Id = pagamentoParcialId });
        }

        public void Excluir(PagamentoParcialModel pagamentoParcial)
            => ExcluirPagamentoParcial(pagamentoParcial.PagamentoID);

        // 3. LISTAR PAGAMENTOS PARCIAIS DE UMA PARCELA        
        public List<PagamentoParcialModel> ObterPagamentosParciaisPorParcela(long parcelaId)
        {
            const string sql = @" SELECT PagamentoParcialID,
                       ParcelaID,
                       ValorPago,
                       DataPagamento
                FROM PagamentosParciais 
                WHERE ParcelaID = @ParcelaID 
                ORDER BY DataPagamento DESC";

            using var conn = GVC.Helpers.Conexao.Conex();
            return conn.Query<PagamentoParcialModel>(sql, new { ParcelaID = parcelaId }).AsList();
        }

        // 4. EXCLUIR TODOS OS PAGAMENTOS PARCIAIS DE UMA PARCELA        
        public void ExcluirPagamentosParciaisPorParcelaID(long parcelaId)
        {
            const string sql = "DELETE FROM PagamentosParciais WHERE ParcelaID = @ParcelaID";
            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Execute(sql, new { ParcelaID = parcelaId });
        }

        // 5. LISTAR TODOS OS PAGAMENTOS PARCIAIS (para relatório)       
        public DataTable ListarPagamentosParciais()
        {
            const string sql = @" SELECT pp.PagamentoParcialID,
                       pp.ParcelaID,
                       p.NumeroParcela,
                       c.Nome,
                       pp.ValorPago,
                       pp.DataPagamento
                FROM PagamentosParciais pp
                INNER JOIN Parcela p ON pp.ParcelaID = p.ParcelaID
                INNER JOIN Venda v ON p.VendaID = v.VendaID
                INNER JOIN Cliente c ON v.ClienteID = c.ClienteID
                ORDER BY pp.DataPagamento DESC";

            using var conn = GVC.Helpers.Conexao.Conex();
            var dt = new DataTable();
            dt.Load(conn.ExecuteReader(sql));
            return dt;
        }

        // 6. TOTAL PAGO PARCIALMENTE EM UMA PARCELA
        public decimal TotalPagoParcialmente(long parcelaId)
        {
            const string sql = @" SELECT ISNULL(SUM(ValorPago), 0) 
                FROM PagamentosParciais WHERE ParcelaID = @ParcelaID";  // ✅ Ajuste para SQL Server

            using var conn = GVC.Helpers.Conexao.Conex();
            return conn.QuerySingle<decimal>(sql, new { ParcelaID = parcelaId });
        }

        // 7. REGISTRAR PAGAMENTO PARCIAL + ATUALIZAR PARCELA AUTOMATICAMENTE       
        public void RegistrarPagamentoParcial(long parcelaId, decimal valorPago, DateTime? dataPagamento = null)
        {
            if (valorPago <= 0) return;
            dataPagamento ??= DateTime.Now;
            using var conn = GVC.Helpers.Conexao.Conex(); conn.Open();
            using var trans = conn.BeginTransaction();

            try
            {
                // 1. Insere o pagamento parcial
                const string sqlInsert = @" INSERT INTO PagamentosParciais (ParcelaID, ValorPago, DataPagamento) 
                    VALUES (@ParcelaID, @ValorPago, @DataPagamento)";

                conn.Execute(sqlInsert, new
                {
                    ParcelaID = parcelaId,
                    ValorPago = valorPago,
                    DataPagamento = dataPagamento
                }, trans);

                // 2. Atualiza a parcela
                const string sqlUpdate = @" UPDATE Parcela SET ValorRecebido = ValorRecebido + @ValorPago,
                        SaldoRestante = ValorParcela - (ValorRecebido + @ValorPago),
                        Pago = CASE WHEN (ValorParcela - (ValorRecebido + @ValorPago)) <= 0.005 THEN 1 ELSE 0 END
                        WHERE ParcelaID = @ParcelaID";   // ✅ Ajuste: expressão booleana convertida em CASE para SQL Server

                conn.Execute(sqlUpdate, new { ParcelaID = parcelaId, ValorPago = valorPago }, trans);
                trans.Commit();
            }
            catch
            {
                trans.Rollback();
                throw;
            }
        }

        // 8. BUSCAR PAGAMENTO PARCIAL POR ID
        public PagamentoParcialModel? BuscarPorId(long pagamentoParcialId)
        {
            const string sql = "SELECT * FROM PagamentosParciais WHERE PagamentoParcialID = @Id";
            using var conn = GVC.Helpers.Conexao.Conex();
            return conn.QueryFirstOrDefault<PagamentoParcialModel>(sql, new { Id = pagamentoParcialId });
        }
    }
}
﻿using System;
using Microsoft.Data.SqlClient;

namespace GVC.DAL
{
    public class PagamentosParciaisDal
    {
        public void ExcluirPorVenda(long vendaId)
        {
            string sql = @"
                DELETE FROM PagamentosParciais
                WHERE ParcelaID IN (
                    SELECT ParcelaID 
                    FROM Parcela 
                    WHERE VendaID = @VendaID
                )";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);
            cmd.ExecuteNonQuery();
        }
    }
}
﻿using Dapper;
using GVC.Helpers;
using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;

namespace GVC.DALL
{
    public class ParcelaDal
    {
        public void InsertParcela(ParcelaModel parcela)
        {
            const string sql = @" INSERT INTO Parcela (
                    VendaID, NumeroParcela, DataVencimento, ValorParcela, ValorRecebido,
                    Status, DataPagamento, Juros, Multa, Observacao)
                VALUES ( @VendaID, @NumeroParcela, @DataVencimento, @ValorParcela, @ValorRecebido,
                    @Status, @DataPagamento, @Juros, @Multa, @Observacao )";
            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Execute(sql, parcela);
        }

        public void InsertParcelas(List<ParcelaModel> parcelas)
        {
            if (!parcelas.Any()) return;

            const string sql = @" INSERT INTO Parcela (
                    VendaID, NumeroParcela, DataVencimento, ValorParcela, ValorRecebido,
                    Status, DataPagamento, Juros, Multa, Observacao
                )
                VALUES (
                    @VendaID, @NumeroParcela, @DataVencimento, @ValorParcela, @ValorRecebido,
                    @Status, @DataPagamento, @Juros, @Multa, @Observacao
                )";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Execute(sql, parcelas);
        }

        public void UpdateParcela(ParcelaModel parcela)
        {
            const string sql = @"UPDATE Parcela 
                SET DataVencimento = @DataVencimento,
                    ValorParcela   = @ValorParcela,
                    ValorRecebido  = @ValorRecebido,
                    Status         = @Status,
                    DataPagamento  = @DataPagamento,
                    Juros          = @Juros,
                    Multa          = @Multa,
                    Observacao     = @Observacao
                WHERE ParcelaID = @ParcelaID";

            using var conn = Helpers.Conexao.Conex();
            conn.Execute(sql, parcela);
        }

        public void BaixarParcela(long parcelaId, decimal valorPago, DateTime dataPagamento)
        {
            const string sql = @" UPDATE Parcela
           SET ValorRecebido = ValorRecebido + @ValorPago,
               DataPagamento = @DataPagamento
         WHERE ParcelaID = @ParcelaID";

            using var conn = Helpers.Conexao.Conex();
            conn.Execute(sql, new
            {
                ParcelaID = parcelaId,
                ValorPago = valorPago,
                DataPagamento = dataPagamento
            });
        }

        public void BaixarParcelasEmLote(List<long> parcelasIds, DateTime dataPagamento)
        {
            if (parcelasIds == null || parcelasIds.Count == 0)
                return;

            using var conn = Helpers.Conexao.Conex();
            conn.Open();
            using var transaction = conn.BeginTransaction();

            try
            {
                const string sqlBaixa = @"
            UPDATE Parcela
            SET ValorRecebido = ValorParcela + Juros + Multa,
                DataPagamento = @DataPagamento
            WHERE ParcelaID = @ParcelaID";

                foreach (var parcelaId in parcelasIds)
                {
                    conn.Execute(sqlBaixa, new
                    {
                        ParcelaID = parcelaId,
                        DataPagamento = dataPagamento
                    }, transaction);
                }

                const string sqlHistorico = @"
            INSERT INTO PagamentosParciais (ParcelaID, DataPagamento, ValorPago, Observacao)
            SELECT 
                ParcelaID,
                @DataPagamento,
                (ValorParcela + Juros + Multa - ValorRecebido),
                'Baixa total em lote'
            FROM Parcela
            WHERE ParcelaID = @ParcelaID";

                foreach (var parcelaId in parcelasIds)
                {
                    conn.Execute(sqlHistorico, new
                    {
                        ParcelaID = parcelaId,
                        DataPagamento = dataPagamento
                    }, transaction);
                }

                transaction.Commit();
            }
            catch
            {
                transaction.Rollback();
                throw;
            }
        }

        public ParcelaModel? BuscarPorId(decimal parcelaId)
        {
            const string sql = "SELECT * FROM Parcela WHERE ParcelaID = @Id";
            using var conn = Helpers.Conexao.Conex();
            return conn.QueryFirstOrDefault<ParcelaModel>(sql, new { Id = parcelaId });
        }

        public List<ParcelaModel> GetParcelas(int vendaId)
        {
            const string sql = @"SELECT *
                FROM Parcela
                WHERE VendaID = @VendaID
                ORDER BY NumeroParcela";

            using var conn = Helpers.Conexao.Conex();
            return conn.Query<ParcelaModel>(sql, new { VendaID = vendaId }).AsList();
        }

        public DataTable ListarParcelas()
        {
            AtualizarParcelasAtrasadas();
            const string sql = "SELECT * FROM Parcela ORDER BY DataVencimento";

            using var conn = Helpers.Conexao.Conex();
            var dt = new DataTable();
            dt.Load(conn.ExecuteReader(sql));
            return dt;
        }

        public DataTable ListarParcelasPendentesPorCliente(int clienteId)
        {
            const string sql = @"SELECT p.*,
                       v.DataVenda,
                       c.Nome
                FROM Parcela p
                INNER JOIN Venda v   ON p.VendaID = v.VendaID
                INNER JOIN Cliente c ON v.ClienteID = c.ClienteID
                WHERE c.ClienteID = @ClienteID
                  AND p.Status = 'Pendente'
                ORDER BY p.DataVencimento";

            using var conn = Helpers.Conexao.Conex();
            var dt = new DataTable();
            dt.Load(conn.ExecuteReader(sql, new { ClienteID = clienteId }));
            return dt;
        }

        public void Excluir(ParcelaModel parcela)
        {
            const string sql = "DELETE FROM Parcela WHERE ParcelaID = @Id";
            using var conn = Helpers.Conexao.Conex();
            conn.Execute(sql, new { Id = parcela.ParcelaID });
        }

        public void EstornarPagamento(long parcelaId, decimal valorEstorno, DateTime dataEstorno, string motivo = null)
        {
            if (valorEstorno <= 0m) throw new ArgumentException("Valor do estorno deve ser maior que zero.");
            if (string.IsNullOrWhiteSpace(motivo)) motivo = "Estorno sem motivo informado";

            string linhaHistorico = $"[{dataEstorno:dd/MM/yyyy HH:mm}] Estorno de {valorEstorno:C2} - Motivo: {motivo}";

            const string sql = @"
UPDATE Parcela
SET ValorRecebido = ValorRecebido - @ValorEstorno,
    Observacao = CASE
        WHEN Observacao IS NULL OR Observacao = '' THEN @LinhaHistorico
        ELSE Observacao + CHAR(13) + CHAR(10) + @LinhaHistorico
    END
WHERE ParcelaID = @ParcelaID;";   // ✅ Ajuste para SQL Server

            using var conn = Helpers.Conexao.Conex();
            conn.Execute(sql, new
            {
                ParcelaID = parcelaId,
                ValorEstorno = valorEstorno,
                LinhaHistorico = linhaHistorico
            });
        }

        public void AtualizarParcelasAtrasadas()
        {
            const string sql = @"
                UPDATE Parcela
                SET Status = 'Atrasada'
                WHERE Status IN ('Pendente', 'Parcialmente Paga')
                  AND DataVencimento < GETDATE()";   // ✅ Ajuste para SQL Server

            using var conn = Helpers.Conexao.Conex();
            conn.Execute(sql);
        }

        public void CancelarParcelasPorVenda(long vendaId)
        {
            string sql = @"
        UPDATE Parcela 
        SET Status = 'CANCELADA',
            ValorRecebido = 0,
            DataPagamento = NULL
        WHERE VendaID = @VendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);
            cmd.ExecuteNonQuery();
        }       
        public bool ExistePagamentoPorVenda(long vendaId)
        {
            string sql = @" SELECT COUNT(1)
        FROM Parcela p
        LEFT JOIN PagamentosParciais pp ON pp.ParcelaID = p.ParcelaID
        WHERE p.VendaID = @VendaID
          AND ( p.ValorRecebido > 0 OR pp.PagamentoID IS NOT NULL )";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);

            return Convert.ToInt32(cmd.ExecuteScalar()) > 0;
        }
        public void ExcluirPorVenda(long vendaId)
        {
            string sql = "DELETE FROM Parcela WHERE VendaID = @VendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);
            cmd.ExecuteNonQuery();
        }
        // 26/12/2025


    }
}
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.DAL
{
    internal class ParcelaExtrato
    {
    }
}
﻿using Dapper;
using GVC.Helpers;
using GVC.MODEL;
using Microsoft.Data.SqlClient; // Alterado para SQL Server
using System;
using System.Collections.Generic;
using System.Data;
using System.Drawing;
using System.Linq;

namespace GVC.DAL
{
    public class ProdutoDALL
    {
        private const string SqlBase = @"SELECT 
    p.ProdutoID,
    p.NomeProduto,
    p.Referencia,
    p.PrecoCusto,
    p.Lucro,
    p.PrecoDeVenda,
    p.Estoque,
    p.DataDeEntrada,
    p.Status,
    p.Situacao,
    p.Unidade,
    p.Marca,
    p.DataValidade,
    p.GtinEan,
    p.Imagem,
    p.FornecedorID,
    COALESCE(f.Nome, '') AS NomeFornecedor
FROM Produtos p
LEFT JOIN Fornecedor f ON p.FornecedorID = f.FornecedorID";

        private readonly string _connectionString = GVC.Helpers.Conexao.Conex().ConnectionString;

        // ==================== LISTAR TODOS ====================
        public List<ProdutosModel> ListarTodos()
        {
            var lista = new List<ProdutosModel>();
            using (var con = new SqlConnection(_connectionString)) // Alterado para SqlConnection
            {
                // SQL Server usa TOP para limitar resultados
                string sql = @"SELECT TOP 100 
                                p.ProdutoID, p.NomeProduto, p.Referencia, p.PrecoCusto, p.Lucro, 
                                p.PrecoDeVenda, p.Estoque, p.DataDeEntrada, p.Status, p.Situacao, 
                                p.Unidade, p.Marca, p.DataValidade, p.GtinEan, p.Imagem, p.FornecedorID,
                                COALESCE(f.Nome, '') AS NomeFornecedor
                                FROM Produtos p
                                LEFT JOIN Fornecedor f ON p.FornecedorID = f.FornecedorID
                                ORDER BY p.NomeProduto";

                using (var cmd = new SqlCommand(sql, con))
                {
                    con.Open();
                    using (var reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            lista.Add(Mapear(reader));
                        }
                    }
                }
            }
            return lista;
        }
        public List<ProdutosModel> ListarProdutoDinamico(string filtro = "")
        {
            var lista = new List<ProdutosModel>();

            using (var conn = Helpers.Conexao.Conex())
            using (var cmd = conn.CreateCommand())
            {
                cmd.CommandText = @"
    SELECT 
         ProdutoID,
         NomeProduto,
         Unidade,
         PrecoDeVenda
     FROM Produtos
    WHERE Status = 'Disponível' 
      AND Situacao = 'Ativo' 
      AND NomeProduto COLLATE Latin1_General_CI_AI LIKE @filtro
    ORDER BY NomeProduto";


                cmd.Parameters.AddWithValue("@filtro", $"%{filtro}%");

                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    while (dr.Read())
                    {
                        lista.Add(new ProdutosModel
                        {
                            ProdutoID = dr.GetInt32(0),
                            NomeProduto = dr.GetString(1),
                            Unidade = dr.IsDBNull(2) ? "" : dr.GetString(2),
                            PrecoDeVenda = dr.GetDecimal(3)
                        });
                    }
                }
            }

            return lista;
        }
        // ==================== BUSCAR POR ID ====================
        public ProdutosModel? BuscarPorId(long id)
        {
            using (var con = new SqlConnection(_connectionString))
            {
                string sql = "SELECT * FROM Produtos WHERE ProdutoID = @id";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@id", id);
                    con.Open();
                    using (var reader = cmd.ExecuteReader())
                    {
                        if (reader.Read())
                            return Mapear(reader);
                    }
                }
            }
            return null;
        }

        // ==================== INSERIR ====================
        public long Inserir(ProdutosModel produto)
        {
            using (var con = new SqlConnection(_connectionString))
            {
                // Alterado last_insert_rowid() para SCOPE_IDENTITY()
                string sql = @"INSERT INTO Produtos 
                    (NomeProduto, Referencia, PrecoCusto, Lucro, PrecoDeVenda, Estoque, DataDeEntrada, 
                     Status, Situacao, Unidade, Marca, DataValidade, GtinEan, Imagem, FornecedorID)
                    VALUES (@NomeProduto, @Referencia, @Custo, @Lucro, @Venda, @Estoque, @Entrada, 
                     @Status, @Situacao, @Unidade, @Marca, @Validade, @Gtin, @Imagem, @FornecedorID); 
                    SELECT CAST(SCOPE_IDENTITY() AS BIGINT);";

                using (var cmd = new SqlCommand(sql, con))
                {
                    AdicionarParametros(cmd, produto);
                    con.Open();
                    // SCOPE_IDENTITY retorna decimal por padrão, por isso o CAST no SQL e no C#
                    return (long)cmd.ExecuteScalar();
                }
            }
        }

        // ==================== ATUALIZAR ====================
        public bool Alterar(ProdutosModel produto)
        {
            using (var con = new SqlConnection(_connectionString))
            {
                string sql = @"
UPDATE Produtos SET 
    NomeProduto     = @NomeProduto,
    Referencia      = @Referencia,
    PrecoCusto      = @Custo,
    Lucro           = @Lucro,
    PrecoDeVenda    = @PrecoDeVenda,
    Estoque         = @Estoque,
    DataDeEntrada   = @DataDeEntrada,
    Status          = @Status,
    Situacao        = @Situacao,
    Unidade         = @Unidade,
    Marca           = @Marca,
    DataValidade    = @Validade,
    GtinEan         = @Gtin,
    Imagem          = @Imagem,
    FornecedorID    = @FornecedorID
WHERE ProdutoID = @Id";


                using (var cmd = new SqlCommand(sql, con))
                {
                    AdicionarParametros(cmd, produto);
                    cmd.Parameters.AddWithValue("@Id", produto.ProdutoID);
                    con.Open();
                    return cmd.ExecuteNonQuery() > 0;
                }
            }
        }
        private void AdicionarParametros(SqlCommand cmd, ProdutosModel p)
        {
            cmd.Parameters.AddWithValue("@NomeProduto", p.NomeProduto ?? (object)DBNull.Value);
            cmd.Parameters.AddWithValue("@Referencia", p.Referencia ?? (object)DBNull.Value);
            cmd.Parameters.AddWithValue("@Custo", p.PrecoCusto);
            cmd.Parameters.AddWithValue("@Lucro", p.Lucro);
            cmd.Parameters.AddWithValue("@PrecoDeVenda", p.PrecoDeVenda);
            cmd.Parameters.AddWithValue("@Estoque", p.Estoque);
            cmd.Parameters.AddWithValue("@DataDeEntrada", p.DataDeEntrada);
            cmd.Parameters.AddWithValue("@Status", p.Status ?? (object)DBNull.Value);
            cmd.Parameters.AddWithValue("@Situacao", p.Situacao ?? (object)DBNull.Value);
            cmd.Parameters.AddWithValue("@Unidade", p.Unidade ?? (object)DBNull.Value);
            cmd.Parameters.AddWithValue("@Marca", p.Marca ?? (object)DBNull.Value);
            cmd.Parameters.AddWithValue("@Validade", p.DataValidade.HasValue ? (object)p.DataValidade.Value : DBNull.Value);
            cmd.Parameters.AddWithValue("@Gtin", p.GtinEan ?? (object)DBNull.Value);
            cmd.Parameters.AddWithValue("@Imagem", p.Imagem ?? (object)DBNull.Value);

            if (p.FornecedorID > 0)
                cmd.Parameters.AddWithValue("@FornecedorID", p.FornecedorID);
            else
                cmd.Parameters.AddWithValue("@FornecedorID", DBNull.Value);
        }
        // ==================== EXCLUIR ====================
        public bool Excluir(long id)
        {
            using (var con = new SqlConnection(_connectionString))
            {
                string sql = "DELETE FROM Produtos WHERE ProdutoID = @id";
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@id", id);
                    con.Open();
                    return cmd.ExecuteNonQuery() > 0;
                }
            }
        }

        // ==================== MÉTODO AUXILIAR MAPEAR ====================
        private ProdutosModel Mapear(SqlDataReader reader)
        {
            return new ProdutosModel
            {
                ProdutoID = Convert.ToInt32(reader["ProdutoID"]),
                NomeProduto = reader["NomeProduto"].ToString(),
                Referencia = reader["Referencia"]?.ToString() ?? "",
                PrecoCusto = Convert.ToDecimal(reader["PrecoCusto"]),
                Lucro = Convert.ToDecimal(reader["Lucro"]),
                PrecoDeVenda = Convert.ToDecimal(reader["PrecoDeVenda"]),
                Estoque = Convert.ToInt64(reader["Estoque"]),
                DataDeEntrada = Convert.ToDateTime(reader["DataDeEntrada"]),
                Status = reader["Status"].ToString(),
                Situacao = reader["Situacao"]?.ToString() ?? "",
                Unidade = reader["Unidade"]?.ToString() ?? "",
                Marca = reader["Marca"]?.ToString() ?? "",
                DataValidade = reader["DataValidade"] != DBNull.Value ? Convert.ToDateTime(reader["DataValidade"]) : (DateTime?)null,
                GtinEan = reader["GtinEan"]?.ToString() ?? "",
                Imagem = reader["Imagem"]?.ToString() ?? "",
                FornecedorID = reader["FornecedorID"] != DBNull.Value ? Convert.ToInt64(reader["FornecedorID"]) : 0,
                Fornecedor = reader.HasColumn("NomeFornecedor") ? reader["NomeFornecedor"].ToString() ?? "" : ""
            };
        }

        // ==================== PESQUISAR POR NOME ====================
        public List<ProdutosModel> PesquisarProdutoPorNome(string nome)
        {
            var lista = new List<ProdutosModel>();
            // SqlServer usa TOP em vez de LIMIT
            string sql = @"SELECT TOP 100 p.*, COALESCE(f.Nome, '') AS NomeFornecedor 
                           FROM Produtos p LEFT JOIN Fornecedor f ON p.FornecedorID = f.FornecedorID
                           WHERE p.NomeProduto LIKE @nome 
                           ORDER BY p.NomeProduto";

            using (var con = new SqlConnection(_connectionString))
            {
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@nome", $"%{nome}%");
                    con.Open();
                    using (var reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            lista.Add(Mapear(reader));
                        }
                    }
                }
            }
            return lista;
        }
        public void BaixarEstoque(long produtoId, int quantidade, SqlTransaction tran)
        {
            string sql = @"UPDATE ProdutosSET Estoque = Estoque - @Quantidade
                        WHERE ProdutoID = @ProdutoID AND Estoque >= @Quantidade";

            using (var con = new SqlConnection(_connectionString))
            {
                using var cmd = new SqlCommand(sql, con);
                cmd.Parameters.AddWithValue("@Quantidade", quantidade);
                cmd.Parameters.AddWithValue("@ProdutoID", produtoId);

                int linhas = cmd.ExecuteNonQuery();
                if (linhas == 0)
                    throw new Exception("Estoque insuficiente para o produto.");
            }            
        }

        // ==================== PESQUISAR POR CÓDIGO (Busca parcial) ====================
        public List<ProdutosModel> PesquisarProdutoPorCodigo(string codigo)
        {
            var lista = new List<ProdutosModel>();
            string sql = @"SELECT TOP 100 p.*, COALESCE(f.Nome, '') AS NomeFornecedor 
                           FROM Produtos p LEFT JOIN Fornecedor f ON p.FornecedorID = f.FornecedorID
                           WHERE CAST(p.ProdutoID AS VARCHAR) LIKE @codigo
                              OR p.Referencia LIKE @codigo
                           ORDER BY p.ProdutoID";

            using (var con = new SqlConnection(_connectionString))
            {
                using (var cmd = new SqlCommand(sql, con))
                {
                    cmd.Parameters.AddWithValue("@codigo", $"%{codigo}%");
                    con.Open();
                    using (var reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            lista.Add(Mapear(reader));
                        }
                    }
                }
            }
            return lista;
        }

        // ==================== PESQUISAR POR CÓDIGO (DataTable/Dapper) ====================
        public DataTable PesquisarPorCodigo(int codigo)
        {
            const string sql = SqlBase + " WHERE p.ProdutoID = @ProdutoID";
            using var conn = new SqlConnection(_connectionString);
            var dt = new DataTable();
            conn.Open();
            // Dapper permite carregar o reader direto no DataTable
            using (var reader = conn.ExecuteReader(sql, new { ProdutoID = codigo }))
            {
                dt.Load(reader);
            }
            return dt;
        }

      

    }


    // Helper para verificar se a coluna existe no reader
    public static class DataReaderExtensions
    {
        public static bool HasColumn(this IDataRecord dr, string columnName)
        {
            for (int i = 0; i < dr.FieldCount; i++)
            {
                if (dr.GetName(i).Equals(columnName, StringComparison.InvariantCultureIgnoreCase))
                    return true;
            }
            return false;
        }
    }
}﻿using GVC.Helpers;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.DAL
{
    public class RelatorioEstoqueDAL
    {
        public DataTable ObterRelatorioEstoque()
        {
            var dt = new DataTable();

            using var conn = Conexao.Conex();
            conn.Open();

            string sql = @"
        SELECT
            p.ProdutoID,
            p.NomeProduto,
            p.Estoque,
            p.PrecoCusto,
            p.PrecoDeVenda,
            (p.Estoque * p.PrecoCusto)   AS ValorTotalCusto,
            (p.Estoque * p.PrecoDeVenda) AS ValorTotalVenda,
            ((p.PrecoDeVenda - p.PrecoCusto) * p.Estoque) AS LucroTotalProduto
        FROM Produtos p
        WHERE p.Situacao = 'Ativo'
        ORDER BY p.NomeProduto";

            using var da = new SqlDataAdapter(sql, conn);
            da.Fill(dt);

            return dt;
        }
    }

}
﻿using GVC.Helpers;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.DAL
{
    public class RelatorioGiroEstoqueDAL
    {
        public DataTable ObterGiro(DateTime inicio, DateTime fim)
        {
            var dt = new DataTable();

            using var conn = Conexao.Conex();
            conn.Open();

            string sql = /* SQL acima */"";

            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@Inicio", inicio);
            cmd.Parameters.AddWithValue("@Fim", fim);

            using var da = new SqlDataAdapter(cmd);
            da.Fill(dt);

            return dt;
        }
    }

}
﻿using GVC.Helpers;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.DAL
{
    public class RelatorioLucroProdutoDAL
    {
        public DataTable RankingLucro()
        {
            var dt = new DataTable();

            using var conn = Conexao.Conex();
            conn.Open();

            string sql = /* SQL acima */"";

            using var da = new SqlDataAdapter(sql, conn);
            da.Fill(dt);

            return dt;
        }
    }

}
﻿using GVC.Helpers;
using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Data;
using System.Windows.Forms;

namespace GVC.DALL
{
    internal class UsuarioDal
    {
        public DataTable ListaUsuario()
        {
            var conn = GVC.Helpers.Conexao.Conex();
            try
            {
                var comando = new SqlCommand("SELECT UsuarioID, NomeCompleto, Cpf, DataNascimento, Email, NomeUsuario, TipoUsuario, Senha, DataCriacao FROM Usuarios", conn);

                conn.Open();
                var reader = comando.ExecuteReader();

                var dtUsuario = new DataTable();
                dtUsuario.Load(reader);
                return dtUsuario;
            }
            finally
            {
                conn.Close();
            }
        }

        public void GravaUsuario(UsuarioMODEL usuarios)
        {
            var conn = GVC.Helpers.Conexao.Conex();
            try
            {
                var sqlcomm = new SqlCommand(
                    "INSERT INTO Usuarios (NomeUsuario, Email, Senha, TipoUsuario, Cpf, DataNascimento, NomeCompleto, DataCriacao) " +
                    "VALUES (@NomeUsuario, @Email, @Senha, @TipoUsuario, @Cpf, @DataNascimento, @NomeCompleto, @DataCriacao)", conn);

                sqlcomm.Parameters.AddWithValue("@NomeUsuario", usuarios.NomeUsuario);
                sqlcomm.Parameters.AddWithValue("@Email", usuarios.Email);
                sqlcomm.Parameters.AddWithValue("@Senha", usuarios.Senha);
                sqlcomm.Parameters.AddWithValue("@TipoUsuario", usuarios.TipoUsuario);
                sqlcomm.Parameters.AddWithValue("@Cpf", usuarios.Cpf);
                sqlcomm.Parameters.AddWithValue("@DataNascimento", usuarios.DataNascimento);
                sqlcomm.Parameters.AddWithValue("@NomeCompleto", usuarios.NomeCompleto);
                sqlcomm.Parameters.AddWithValue("@DataCriacao", usuarios.DataCriacao);

                conn.Open();
                sqlcomm.ExecuteNonQuery();
            }
            finally
            {
                conn.Close();
            }
        }

        public void ExcluiUsuario(UsuarioMODEL usuarios)
        {
            var conn = GVC.Helpers.Conexao.Conex();
            try
            {
                var sqlcomando = new SqlCommand("DELETE FROM Usuarios WHERE UsuarioID = @UsuarioID", conn);
                sqlcomando.Parameters.AddWithValue("@UsuarioID", usuarios.UsuarioID);

                conn.Open();
                sqlcomando.ExecuteNonQuery();
            }
            finally
            {
                conn.Close();
            }
        }

        public void Atualizar(UsuarioMODEL usuarios)
        {
            var conn = GVC.Helpers.Conexao.Conex();
            try
            {
                var sqlcomm = new SqlCommand(
                    "UPDATE Usuarios SET NomeUsuario = @NomeUsuario, Email = @Email, Senha = @Senha, " +
                    "TipoUsuario = @TipoUsuario, Cpf = @Cpf, DataNascimento = @DataNascimento, NomeCompleto = @NomeCompleto " +
                    "WHERE UsuarioID = @UsuarioID", conn);

                sqlcomm.Parameters.AddWithValue("@NomeUsuario", usuarios.NomeUsuario);
                sqlcomm.Parameters.AddWithValue("@Email", usuarios.Email);
                sqlcomm.Parameters.AddWithValue("@Senha", usuarios.Senha);
                sqlcomm.Parameters.AddWithValue("@TipoUsuario", usuarios.TipoUsuario);
                sqlcomm.Parameters.AddWithValue("@Cpf", usuarios.Cpf);
                sqlcomm.Parameters.AddWithValue("@DataNascimento", usuarios.DataNascimento);
                sqlcomm.Parameters.AddWithValue("@NomeCompleto", usuarios.NomeCompleto);
                sqlcomm.Parameters.AddWithValue("@UsuarioID", usuarios.UsuarioID);

                conn.Open();
                sqlcomm.ExecuteNonQuery();
            }
            finally
            {
                conn.Close();
            }
        }

        public void AtualizaUsuarioSenha(UsuarioMODEL usuarios)
        {
            var conn = GVC.Helpers.Conexao.Conex();
            try
            {
                var sqlcomm = new SqlCommand("UPDATE Usuarios SET Senha = @Senha WHERE UsuarioID = @UsuarioID", conn);

                sqlcomm.Parameters.AddWithValue("@Senha", usuarios.Senha);
                sqlcomm.Parameters.AddWithValue("@UsuarioID", usuarios.UsuarioID);

                conn.Open();
                sqlcomm.ExecuteNonQuery();
            }
            finally
            {
                conn.Close();
            }
        }

        public DataTable PesquisarPorNome(string nome)
        {
            var conn = GVC.Helpers.Conexao.Conex();
            try
            {
                var sqlconn = "SELECT UsuarioID, NomeCompleto, Cpf, DataNascimento, Email, NomeUsuario, TipoUsuario, Senha, DataCriacao FROM Usuarios WHERE NomeUsuario LIKE @NomeUsuario";
                var cmd = new SqlCommand(sqlconn, conn);
                cmd.Parameters.AddWithValue("@NomeUsuario", "%" + nome + "%");

                conn.Open();
                var reader = cmd.ExecuteReader();

                var dt = new DataTable();
                dt.Load(reader);

                return dt;
            }
            catch (Exception ex)
            {
                MessageBox.Show("Erro ao executar a pesquisa: " + ex.Message);
                return null;
            }
            finally
            {
                conn.Close();
            }
        }

        public DataTable PesquisarPorCodigo(int nome)
        {
            var conn = GVC.Helpers.Conexao.Conex();
            try
            {
                DataTable dt = new DataTable();

                string sqlconn = "SELECT UsuarioID, NomeCompleto, Cpf, DataNascimento, Email, NomeUsuario, TipoUsuario, Senha, DataCriacao FROM Usuarios WHERE UsuarioID = @UsuarioID";

                using (SqlCommand cmd = new SqlCommand(sqlconn, conn))
                {
                    cmd.Parameters.AddWithValue("@UsuarioID", Convert.ToInt32(nome));

                    conn.Open();
                    using (SqlDataReader reader = cmd.ExecuteReader())
                    {
                        dt.Load(reader);
                    }
                }
                return dt;
            }
            catch (Exception ex)
            {
                MessageBox.Show("Erro ao executar a pesquisa: " + ex.Message);
                return null;
            }
            finally
            {
                if (conn.State == ConnectionState.Open)
                {
                    conn.Close();
                }
                conn.Dispose();
            }
        }
    }
}
﻿using GVC.Helpers;
using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System.Collections.Generic;

namespace GVC.DALL
{
    public class VendaAtualizacaoDal
    {
        // ============================
        // MÉTODO PÚBLICO (ENTRY POINT)
        // ============================
        public void AtualizarVendaCompleta(
            VendaModel venda,
            List<ItemVendaModel> itens,
            List<ParcelaModel> parcelas)
        {
            using var conn = Conexao.Conex();
            conn.Open();

            using var tran = conn.BeginTransaction();

            try
            {
                // 1️⃣ Atualiza cabeçalho da venda
                AtualizarVenda(venda, conn, tran);

                // 2️⃣ Itens
                ExcluirItens(venda.VendaID, conn, tran);
                InserirItens(venda.VendaID, itens, conn, tran);

                // 3️⃣ Parcelas
                ExcluirParcelas(venda.VendaID, conn, tran);
                InserirParcelas(venda.VendaID, parcelas, conn, tran);

                tran.Commit();
            }
            catch
            {
                tran.Rollback();
                throw;
            }
        }

        // ============================
        // MÉTODOS PRIVADOS (AUXILIARES)
        // ============================

        private void AtualizarVenda(
            VendaModel venda,
            SqlConnection conn,
            SqlTransaction tran)
        {
            string sql = @"
                UPDATE Venda
                SET ClienteID   = @ClienteID,
                    FormaPgtoID = @FormaPgtoID,
                    DataVenda   = @DataVenda,
                    ValorTotal  = @ValorTotal,
                    Desconto    = @Desconto,
                    Observacoes = @Observacoes,
                    StatusVenda = @StatusVenda
                WHERE VendaID = @VendaID";

            using var cmd = new SqlCommand(sql, conn, tran);
            cmd.Parameters.AddWithValue("@VendaID", venda.VendaID);
            cmd.Parameters.AddWithValue("@ClienteID", venda.ClienteID);
            cmd.Parameters.AddWithValue("@FormaPgtoID", venda.FormaPgtoID ?? (object)DBNull.Value);
            cmd.Parameters.AddWithValue("@DataVenda", venda.DataVenda);
            cmd.Parameters.AddWithValue("@ValorTotal", venda.ValorTotal);
            cmd.Parameters.AddWithValue("@Desconto", venda.Desconto);
            cmd.Parameters.AddWithValue("@Observacoes", (object)venda.Observacoes ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@StatusVenda", venda.StatusVenda);

            cmd.ExecuteNonQuery();
        }

        private void ExcluirItens(
            long vendaId,
            SqlConnection conn,
            SqlTransaction tran)
        {
            string sql = "DELETE FROM ItemVenda WHERE VendaID = @VendaID";

            using var cmd = new SqlCommand(sql, conn, tran);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);
            cmd.ExecuteNonQuery();
        }

        private void InserirItens(
            long vendaId,
            List<ItemVendaModel> itens,
            SqlConnection conn,
            SqlTransaction tran)
        {
            string sql = @"
                INSERT INTO ItemVenda
                (VendaID, ProdutoID, Quantidade, PrecoUnitario, Subtotal, DescontoItem)
                VALUES
                (@VendaID, @ProdutoID, @Quantidade, @PrecoUnitario, @Subtotal, @DescontoItem)";

            foreach (var item in itens)
            {
                using var cmd = new SqlCommand(sql, conn, tran);
                cmd.Parameters.AddWithValue("@VendaID", vendaId);
                cmd.Parameters.AddWithValue("@ProdutoID", item.ProdutoID);
                cmd.Parameters.AddWithValue("@Quantidade", item.Quantidade);
                cmd.Parameters.AddWithValue("@PrecoUnitario", item.PrecoUnitario);
                cmd.Parameters.AddWithValue("@Subtotal", item.Subtotal);
                cmd.Parameters.AddWithValue("@DescontoItem", item.DescontoItem ?? 0);

                cmd.ExecuteNonQuery();
            }
        }

        private void ExcluirParcelas(
            long vendaId,
            SqlConnection conn,
            SqlTransaction tran)
        {
            string sql = "DELETE FROM Parcela WHERE VendaID = @VendaID";

            using var cmd = new SqlCommand(sql, conn, tran);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);
            cmd.ExecuteNonQuery();
        }

        private void InserirParcelas(
            long vendaId,
            List<ParcelaModel> parcelas,
            SqlConnection conn,
            SqlTransaction tran)
        {
            string sql = @"
                INSERT INTO Parcela
                (VendaID, NumeroParcela, DataVencimento, ValorParcela,
                 ValorRecebido, Status, DataPagamento, Juros, Multa, Observacao)
                VALUES
                (@VendaID, @NumeroParcela, @DataVencimento, @ValorParcela,
                 @ValorRecebido, @Status, @DataPagamento, @Juros, @Multa, @Observacao)";

            foreach (var p in parcelas)
            {
                using var cmd = new SqlCommand(sql, conn, tran);
                cmd.Parameters.AddWithValue("@VendaID", vendaId);
                cmd.Parameters.AddWithValue("@NumeroParcela", p.NumeroParcela);
                cmd.Parameters.AddWithValue("@DataVencimento", p.DataVencimento);
                cmd.Parameters.AddWithValue("@ValorParcela", p.ValorParcela);
                cmd.Parameters.AddWithValue("@ValorRecebido", p.ValorRecebido);
                cmd.Parameters.AddWithValue("@Status", p.Status);
                cmd.Parameters.AddWithValue("@DataPagamento", (object)p.DataPagamento ?? DBNull.Value);
                cmd.Parameters.AddWithValue("@Juros", p.Juros);
                cmd.Parameters.AddWithValue("@Multa", p.Multa);
                cmd.Parameters.AddWithValue("@Observacao", (object)p.Observacao ?? DBNull.Value);

                cmd.ExecuteNonQuery();
            }
        }
    }
}
﻿using GVC.Helpers;
using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System.Collections.Generic;

namespace GVC.DALL
{
    public class VendaConsultaDal
    {
       

        public VendaCompletaModel ObterVendaCompleta(long vendaId)
        {
            var venda = new VendaCompletaModel
            {
                Itens = new List<ItemVendaModel>(),
                Parcelas = new List<ParcelaModel>()
            };

            using var conn = Conexao.Conex();
            conn.Open();

            // VENDA + CLIENTE + ITENS
            string sqlVenda = @"
                            SELECT
                                v.VendaID,
                                v.ClienteID,
                                c.Nome AS ClienteNome,
                                c.Cpf AS CpfCliente, 
                                v.Desconto,
                                v.Observacoes,
                                v.FormaPgtoID,
                                iv.ItemVendaID,
                                iv.ProdutoID,
                                p.NomeProduto AS ProdutoDescricao,
                                iv.Quantidade,
                                iv.PrecoUnitario,
                                iv.DescontoItem,
                                iv.Subtotal
                            FROM Venda v
                            INNER JOIN Clientes c ON c.ClienteID = v.ClienteID
                            INNER JOIN ItemVenda iv ON iv.VendaID = v.VendaID
                            INNER JOIN Produtos p ON p.ProdutoID = iv.ProdutoID
                            WHERE v.VendaID = @VendaID";

            using (var cmd = new SqlCommand(sqlVenda, conn))
            {
                cmd.Parameters.AddWithValue("@VendaID", vendaId);

                using var dr = cmd.ExecuteReader();
                if (dr.Read())
                {
                    venda.VendaID = vendaId;
                    venda.ClienteID = (int)dr["ClienteID"];
                    venda.ClienteNome = dr["ClienteNome"].ToString();
                    //venda.CpfCliente = dr["CpfCliente"].ToString();
                    venda.CpfCliente = dr["CpfCliente"]?.ToString();
                    venda.Desconto = (decimal)dr["Desconto"];
                    venda.Observacoes = dr["Observacoes"]?.ToString();
                    venda.FormaPgtoID = (int)dr["FormaPgtoID"];
                }
            }

            // ITENS
            string sqlItens = @"SELECT
                            iv.ProdutoID,
                            p.NomeProduto AS ProdutoDescricao,
                            iv.Quantidade,
                            iv.PrecoUnitario,
                            iv.Subtotal,
                            iv.DescontoItem
                        FROM ItemVenda iv
                        INNER JOIN Produtos p ON p.ProdutoID = iv.ProdutoID
                        WHERE iv.VendaID = @VendaID";
            using (var cmd = new SqlCommand(sqlItens, conn))
            {
                cmd.Parameters.AddWithValue("@VendaID", vendaId);
                using var dr = cmd.ExecuteReader();
                while (dr.Read())
                {
                    venda.Itens.Add(new ItemVendaModel
                    {
                        ProdutoID = (int)dr["ProdutoID"],
                        ProdutoDescricao = dr["ProdutoDescricao"].ToString(), // 🔥 AQUI
                        Quantidade = (int)dr["Quantidade"],
                        PrecoUnitario = (decimal)dr["PrecoUnitario"],
                        Subtotal = (decimal)dr["Subtotal"],
                        DescontoItem = dr["DescontoItem"] as decimal?
                    });
                }

            }

            // PARCELAS
            string sqlParcelas = @"SELECT * FROM Parcela WHERE VendaID = @VendaID";
            using (var cmd = new SqlCommand(sqlParcelas, conn))
            {
                cmd.Parameters.AddWithValue("@VendaID", vendaId);
                using var dr = cmd.ExecuteReader();
                while (dr.Read())
                {
                    venda.Parcelas.Add(new ParcelaModel
                    {
                        NumeroParcela = (int)dr["NumeroParcela"],
                        DataVencimento = (DateTime)dr["DataVencimento"],
                        ValorParcela = (decimal)dr["ValorParcela"],
                        Status = dr["Status"].ToString()
                    });
                }
            }

            return venda;
        }
    }
}
﻿using GVC.Helpers;
using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using static GVC.View.FrmVendas;

namespace GVC.DALL
{
    public class VendaDal
    {
        private string CalcularStatusVendaPorParcelas(List<ParcelaModel> parcelas)
        {
            if (parcelas == null || !parcelas.Any())
                return null;

            decimal total = parcelas.Sum(p => p.ValorParcela + p.Juros + p.Multa);
            decimal recebido = parcelas.Sum(p => p.ValorRecebido);

            if (recebido <= 0)
                return EnumStatusVenda.Aberta.ToDb();
            if (recebido >= total)
                return EnumStatusVenda.Concluida.ToDb();
            return EnumStatusVenda.ParcialmentePago.ToDb();
        }

        public int AddVendaCompleta(VendaModel venda, List<ItemVendaModel> itens, List<ParcelaModel> parcelas = null)
        {
            if (parcelas != null && parcelas.Any())
            {
                var statusCalculado = CalcularStatusVendaPorParcelas(parcelas);
                if (!string.IsNullOrWhiteSpace(statusCalculado))
                    venda.StatusVenda = statusCalculado;
            }

            string sqlVenda = @"
                INSERT INTO Venda (DataVenda, ClienteID, ValorTotal, FormaPgtoID, Desconto, Observacoes, StatusVenda, VendedorID)
                VALUES (@DataVenda, @ClienteID, @ValorTotal, @FormaPgtoID, @Desconto, @Observacoes, @StatusVenda, @VendedorID);
                SELECT CAST(SCOPE_IDENTITY() AS INT);";

            string sqlItem = @" INSERT INTO ItemVenda (VendaID, ProdutoID, Quantidade, PrecoUnitario, Subtotal, DescontoItem)
            VALUES (@VendaID, @ProdutoID, @Quantidade, @PrecoUnitario, CAST(@Quantidade AS DECIMAL(18,2)) * @PrecoUnitario, @DescontoItem)";

            string sqlParcela = @"
                INSERT INTO Parcela (VendaID, NumeroParcela, DataVencimento, ValorParcela, ValorRecebido,
                                     Status, DataPagamento, Juros, Multa, Observacao)
                VALUES (@VendaID, @NumeroParcela, @DataVencimento, @ValorParcela, @ValorRecebido,
                        @Status, @DataPagamento, @Juros, @Multa, @Observacao)";

            string sqlBaixarEstoque = @" UPDATE Produtos 
                                         SET Estoque = Estoque - @Quantidade
                                         WHERE ProdutoID = @ProdutoID AND Estoque >= @Quantidade";


            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var transaction = conn.BeginTransaction();

            try
            {
                // 1️⃣ Inserir Venda e obter o ID gerado
                using (var cmdVenda = new SqlCommand(sqlVenda, conn, transaction))
                {
                    cmdVenda.Parameters.AddWithValue("@DataVenda", venda.DataVenda);
                    cmdVenda.Parameters.AddWithValue("@ClienteID", venda.ClienteID);
                    cmdVenda.Parameters.AddWithValue("@ValorTotal", venda.ValorTotal);
                    //cmdVenda.Parameters.AddWithValue("@FormaPgtoID", venda.FormaPgtoID);
                    cmdVenda.Parameters.AddWithValue("@FormaPgtoID", venda.FormaPgtoID ?? (object)DBNull.Value); // este pode ser NULL
                    cmdVenda.Parameters.AddWithValue("@Desconto", venda.Desconto);
                    //cmdVenda.Parameters.AddWithValue("@Desconto", venda.Desconto ?? 0m);
                    cmdVenda.Parameters.AddWithValue("@Observacoes", (object)venda.Observacoes ?? DBNull.Value);
                    cmdVenda.Parameters.AddWithValue("@StatusVenda", (object)venda.StatusVenda ?? DBNull.Value);
                    cmdVenda.Parameters.AddWithValue("@VendedorID", venda.VendedorID);

                    int vendaId = (int)cmdVenda.ExecuteScalar();

                    // 2️⃣ Inserir Itens
                    if (itens != null && itens.Any())
                    {
                        // NO VendaDal, método AddVendaCompleta:
                        foreach (var item in itens)
                        {
                            item.VendaID = vendaId;

                            // Calcular subtotal se necessário
                            if (!item.Subtotal.HasValue)
                            {
                                item.Subtotal = (decimal)item.Quantidade * item.PrecoUnitario;
                            }

                            using var cmdItem = new SqlCommand(sqlItem, conn, transaction);
                            cmdItem.Parameters.AddWithValue("@VendaID", item.VendaID);
                            cmdItem.Parameters.AddWithValue("@ProdutoID", item.ProdutoID);
                            cmdItem.Parameters.AddWithValue("@Quantidade", item.Quantidade);
                            cmdItem.Parameters.AddWithValue("@PrecoUnitario", item.PrecoUnitario);

                            // ⭐⭐ SOLUÇÃO DEFINITIVA PARA DescontoItem nullable ⭐⭐
                            decimal descontoItemValor = (decimal)item.DescontoItem;
                            cmdItem.Parameters.AddWithValue("@DescontoItem", descontoItemValor);

                            cmdItem.ExecuteNonQuery();

                            using var cmdEstoque = new SqlCommand(sqlBaixarEstoque, conn, transaction);
                            cmdEstoque.Parameters.AddWithValue("@ProdutoID", item.ProdutoID);
                            cmdEstoque.Parameters.AddWithValue("@Quantidade", item.Quantidade);

                            int linhasAfetadas = cmdEstoque.ExecuteNonQuery();

                            if (linhasAfetadas == 0)
                            {
                                throw new Exception(
                                    $"Estoque insuficiente para o produto ID {item.ProdutoID}."
                                );
                            }

                        }
                    }

                    // 3️⃣ Inserir Parcelas
                    if (parcelas != null && parcelas.Any())
                    {
                        foreach (var p in parcelas)
                        {
                            p.VendaID = vendaId;
                            if (p.Status == EnumStatusParcela.Paga.ToDb() && p.DataPagamento == null)
                                p.DataPagamento = DateTime.Now;

                            using var cmdParcela = new SqlCommand(sqlParcela, conn, transaction);
                            cmdParcela.Parameters.AddWithValue("@VendaID", p.VendaID);
                            cmdParcela.Parameters.AddWithValue("@NumeroParcela", p.NumeroParcela);
                            cmdParcela.Parameters.AddWithValue("@DataVencimento", p.DataVencimento);
                            cmdParcela.Parameters.AddWithValue("@ValorParcela", p.ValorParcela);
                            cmdParcela.Parameters.AddWithValue("@ValorRecebido", p.ValorRecebido);
                            //cmdParcela.Parameters.AddWithValue("@ValorRecebido", p.ValorRecebido == 0 ? (object)DBNull.Value : p.ValorRecebido);                            
                            cmdParcela.Parameters.AddWithValue("@Status", (object)p.Status ?? DBNull.Value);
                            cmdParcela.Parameters.AddWithValue("@DataPagamento", (object)p.DataPagamento ?? DBNull.Value);
                            cmdParcela.Parameters.AddWithValue("@Juros", p.Juros);
                            cmdParcela.Parameters.AddWithValue("@Multa", p.Multa);
                            //cmdParcela.Parameters.AddWithValue("@Juros", p.Juros == 0 ? (object)DBNull.Value : p.Juros);
                            //cmdParcela.Parameters.AddWithValue("@Multa", p.Multa == 0 ? (object)DBNull.Value : p.Multa);
                            cmdParcela.Parameters.AddWithValue("@Observacao", (object)p.Observacao ?? DBNull.Value);
                            cmdParcela.ExecuteNonQuery();
                        }
                    }

                    transaction.Commit();
                    return vendaId;
                }
            }
            catch
            {
                transaction.Rollback();
                throw;
            }
        }

        public void UpdateVenda(VendaModel venda)
        {
            string sql = @"
                UPDATE Venda
                SET DataVenda = @DataVenda,
                    ClienteID = @ClienteID,
                    ValorTotal = @ValorTotal,
                    FormaPgtoID = @FormaPgtoID,
                    Desconto = @Desconto,
                    Observacoes = @Observacoes,
                    StatusVenda = @StatusVenda
                    VendedorID = @VendedorID
                WHERE VendaID = @VendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", venda.VendaID);
            cmd.Parameters.AddWithValue("@DataVenda", venda.DataVenda);
            cmd.Parameters.AddWithValue("@ClienteID", venda.ClienteID);
            cmd.Parameters.AddWithValue("@ValorTotal", venda.ValorTotal);
            cmd.Parameters.AddWithValue("@FormaPgtoID", venda.FormaPgtoID);
            cmd.Parameters.AddWithValue("@Desconto", venda.Desconto == 0 ? (object)DBNull.Value : venda.Desconto);
            cmd.Parameters.AddWithValue("@Observacoes", (object)venda.Observacoes ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@StatusVenda", (object)venda.StatusVenda ?? DBNull.Value);
            cmd.Parameters.AddWithValue("@VendedorID",venda.VendedorID);
            cmd.ExecuteNonQuery();
        }

        public void DeleteVenda(long vendaId)
        {
            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var trans = conn.BeginTransaction();
            try
            {
                using var cmd1 = new SqlCommand("DELETE FROM ItemVenda WHERE VendaID = @Id", conn, trans);
                cmd1.Parameters.AddWithValue("@Id", vendaId);
                cmd1.ExecuteNonQuery();

                using var cmd2 = new SqlCommand("DELETE FROM Parcela WHERE VendaID = @Id", conn, trans);
                cmd2.Parameters.AddWithValue("@Id", vendaId);
                cmd2.ExecuteNonQuery();

                using var cmd3 = new SqlCommand("DELETE FROM Venda WHERE VendaID = @Id", conn, trans);
                cmd3.Parameters.AddWithValue("@Id", vendaId);
                cmd3.ExecuteNonQuery();

                trans.Commit();
            }
            catch
            {
                trans.Rollback();
                throw;
            }
        }

        public void DeleteVenda(VendaModel venda) => DeleteVenda(venda.VendaID);

        public VendaModel? GetVenda(int vendaId)
        {
            string sql = "SELECT * FROM Venda WHERE VendaID = @VendaID";
            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);

            using var reader = cmd.ExecuteReader();
            if (reader.Read())
            {
                return new VendaModel
                {
                    VendaID = reader.GetInt32("VendaID"),
                    DataVenda = reader.GetDateTime("DataVenda"),
                    ClienteID = reader.GetInt32("ClienteID"),
                    ValorTotal = reader.GetDecimal("ValorTotal"),
                    FormaPgtoID = reader.GetInt32("FormaPgtoID"),
                    Desconto = (decimal)(reader.IsDBNull("Desconto") ? (decimal?)null : reader.GetDecimal("Desconto")),
                    Observacoes = reader.IsDBNull("Observacoes") ? null : reader.GetString("Observacoes") as string,
                    StatusVenda = reader.IsDBNull("StatusVenda") ? null : reader.GetString("StatusVenda"),
                    VendedorID = reader.GetInt32("VendedorID")
                };
            }
            return null;
        }

        public DataTable ListarVendas()
        {
            string sql = @" SELECT
                v.VendaID,
                v.DataVenda,
                c.Nome,
                v.ValorTotal,
                v.Desconto,
                v.Observacoes,
                v.StatusVenda,
                v.VendedorID
                f.FormaPgto AS FormaPagamento
            FROM Venda v
            INNER JOIN Cliente c ON v.ClienteID = c.ClienteID
            LEFT JOIN FormaPgto f ON v.FormaPgtoID = f.FormaPgtoID
            ORDER BY v.DataVenda DESC";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            var dt = new DataTable();
            using var reader = cmd.ExecuteReader();
            dt.Load(reader);
            return dt;
        }

        public DataTable VendaLocalizarPorCliente(long clienteId)
        {
            string sql = @" SELECT
                v.VendaID,
                v.DataVenda,
                v.ValorTotal,
                v.Desconto,
                v.Observacoes,
                v.StatusVenda,
                v.VendedorID
                f.FormaPgto AS FormaPagamento
            FROM Venda v
            LEFT JOIN FormaPgto f ON v.FormaPgtoID = f.FormaPgtoID
            WHERE v.ClienteID = @ClienteID
            ORDER BY v.DataVenda DESC";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@ClienteID", clienteId);
            var dt = new DataTable();
            using var reader = cmd.ExecuteReader();
            dt.Load(reader);
            return dt;
        }

        public DataTable RelatorioVendasPorPeriodo(DateTime inicio, DateTime fim)
        {
            string sql = @" SELECT
                v.VendaID,
                v.DataVenda,
                c.Nome,
                v.ValorTotal,
                v.Desconto,
                v.Observacoes,
                v.StatusVenda,
                v.VendedorID
                f.FormaPgto AS FormaPagamento
            FROM Venda v
            INNER JOIN Cliente c ON v.ClienteID = c.ClienteID
            LEFT JOIN FormaPgto f ON v.FormaPgtoID = f.FormaPgtoID
            WHERE v.DataVenda BETWEEN @Inicio AND @Fim
            ORDER BY v.DataVenda DESC";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@Inicio", inicio.Date);
            cmd.Parameters.AddWithValue("@Fim", fim.Date.AddDays(1).AddSeconds(-1));
            var dt = new DataTable();
            using var reader = cmd.ExecuteReader();
            dt.Load(reader);
            return dt;
        }

        public decimal TotalVendidoHoje()
        {
            string sql = @" SELECT COALESCE(SUM(ValorTotal), 0)
                            FROM Venda 
                            WHERE CAST(DataVenda AS DATE) = CAST(GETDATE() AS DATE)";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            return (decimal)cmd.ExecuteScalar();
        }

        public int UltimaVendaId()
        {
            string sql = "SELECT ISNULL(MAX(VendaID), 0) FROM Venda";
            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            return (int)cmd.ExecuteScalar();
        }
        public void AtualizarStatusVenda(long vendaId, string novoStatus)
        {
            string sql = @"UPDATE Venda SET StatusVenda = @Status WHERE VendaID = @VendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);
            cmd.Parameters.AddWithValue("@Status", novoStatus);
            cmd.ExecuteNonQuery();
        }

        public void AtualizarStatusVenda(long vendaId, string novoStatus, string motivo)
        {
            string sql = @"
        UPDATE Venda 
        SET StatusVenda = @Status,
            Observacoes =
                CASE 
                    WHEN Observacoes IS NULL OR Observacoes = ''
                        THEN @Motivo
                    ELSE Observacoes + CHAR(13) + CHAR(10) + @Motivo
                END
        WHERE VendaID = @VendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);
            cmd.Parameters.AddWithValue("@Status", novoStatus);
            cmd.Parameters.AddWithValue("@Motivo", $"CANCELAMENTO: {motivo}");
            cmd.ExecuteNonQuery();
        }

        public VendaModel ObterVendaPorId(int vendaId)
        {
            string sql = @" SELECT
    v.VendaID,
    v.ClienteID,
    v.FormaPgtoID,
    v.DataVenda,
    v.ValorTotal,
    v.Desconto,
    v.Observacoes,
    v.StatusVenda,
    v.VendedorID,
    c.Nome AS NomeCliente
FROM Venda v
LEFT JOIN Clientes c ON c.ClienteID = v.ClienteID
WHERE v.VendaID = @VendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);

            using var reader = cmd.ExecuteReader();
            if (reader.Read())
            {
                var venda = new VendaModel
                {
                    VendaID = reader.GetInt32("VendaID"),
                    ClienteID = reader.GetInt32("ClienteID"),
                    FormaPgtoID = reader.GetInt32("FormaPgtoID"),
                    DataVenda = reader.GetDateTime("DataVenda"),
                    ValorTotal = reader.GetDecimal("ValorTotal"),
                    Desconto = (decimal)(reader.IsDBNull("Desconto") ? (decimal?)null : reader.GetDecimal("Desconto")),
                    Observacoes = reader.IsDBNull("Observacoes") ? null : reader.GetString("Observacoes") as string,
                    StatusVenda = reader.IsDBNull("StatusVenda") ? null : reader.GetString("StatusVenda"),
                    VendedorID = reader.GetInt32("VendedorID")
                };

                if (!reader.IsDBNull("NomeCliente"))
                    venda.NomeCliente = reader.GetString("NomeCliente");

                return venda;
            }
            return null;
        }
        public void Excluir(int vendaID)
        {
            using var conn = Helpers.Conexao.Conex();
            var cmd = conn.CreateCommand();
            cmd.CommandText = "DELETE FROM Venda WHERE VendaID = @id";
            cmd.Parameters.AddWithValue("@id", vendaID);
            cmd.ExecuteNonQuery();
        }
        public void Excluir(long vendaId)
        {
            string sql = "DELETE FROM Venda WHERE VendaID = @VendaID";

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);
            cmd.ExecuteNonQuery();
        }

    }
}