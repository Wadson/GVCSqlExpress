using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.BLL
{
    internal class Cidade
    {
        /*
         * 
         * 
         * 
         * 


Insert into Estado ( Nome, Uf, Regiao) values (12, 'Acre', 'AC', 1);
Insert into Estado ( Nome, Uf, Regiao) values (27, 'Alagoas', 'AL', 2);
Insert into Estado ( Nome, Uf, Regiao) values (16, 'Amapá', 'AP', 1);
Insert into Estado ( Nome, Uf, Regiao) values (13, 'Amazonas', 'AM', 1);
Insert into Estado ( Nome, Uf, Regiao) values (29, 'Bahia', 'BA', 2);
Insert into Estado ( Nome, Uf, Regiao) values (23, 'Ceará', 'CE', 2);
Insert into Estado ( Nome, Uf, Regiao) values (53, 'Distrito Federal', 'DF', 5);
Insert into Estado ( Nome, Uf, Regiao) values (32, 'Espírito Santo', 'ES', 3);
Insert into Estado ( Nome, Uf, Regiao) values (52, 'Goiás', 'GO', 5);
Insert into Estado ( Nome, Uf, Regiao) values (21, 'Maranhão', 'MA', 2);
Insert into Estado ( Nome, Uf, Regiao) values (51, 'Mato Grosso', 'MT', 5);
Insert into Estado ( Nome, Uf, Regiao) values (50, 'Mato Grosso do Sul', 'MS', 5);
Insert into Estado ( Nome, Uf, Regiao) values (31, 'Minas Gerais', 'MG', 3);
Insert into Estado ( Nome, Uf, Regiao) values (15, 'Pará', 'PA', 1);
Insert into Estado ( Nome, Uf, Regiao) values (25, 'Paraíba', 'PB', 2);
Insert into Estado ( Nome, Uf, Regiao) values (41, 'Paraná', 'PR', 4);
Insert into Estado ( Nome, Uf, Regiao) values (26, 'Pernambuco', 'PE', 2);
Insert into Estado ( Nome, Uf, Regiao) values (22, 'Piauí', 'PI', 2);
Insert into Estado ( Nome, Uf, Regiao) values (33, 'Rio de Janeiro', 'RJ', 3);
Insert into Estado ( Nome, Uf, Regiao) values (24, 'Rio Grande do Norte', 'RN', 2);
Insert into Estado ( Nome, Uf, Regiao) values (43, 'Rio Grande do Sul', 'RS', 4);
Insert into Estado ( Nome, Uf, Regiao) values (11, 'Rondônia', 'RO', 1);
Insert into Estado ( Nome, Uf, Regiao) values (14, 'Roraima', 'RR', 1);
Insert into Estado ( Nome, Uf, Regiao) values (42, 'Santa Catarina', 'SC', 4);
Insert into Estado ( Nome, Uf, Regiao) values (35, 'São Paulo', 'SP', 3);
Insert into Estado ( Nome, Uf, Regiao) values (28, 'Sergipe', 'SE', 2);
Insert into Estado ( Nome, Uf, Regiao) values (17, 'Tocantins', 'TO', 1);
         * */
    }
}
﻿using GVC.DALL;
using GVC.MODEL;
using System;
using System.Collections.Generic;
using Microsoft.Data.SqlClient;
using System.Data;
using GVC.Helpers;

namespace GVC.BLL
{
    internal class CidadeBLL
    {
        CidadeDal CidadeDal = null;

        public DataTable Listar()
        {
            DataTable dtable = new DataTable();
            try
            {
                CidadeDal = new CidadeDal();
                dtable = CidadeDal.Listar_Cidades();
            }
            catch (Exception erro)
            {
                throw erro;
            }
            return dtable;
        }

        public void Salvar(CidadeMODEL cidades)
        {
            try
            {
                CidadeDal = new CidadeDal();
                CidadeDal.Salvar(cidades);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }

        public void Excluir(CidadeMODEL cidades)
        {
            try
            {
                CidadeDal = new CidadeDal();
                CidadeDal.Excluir(cidades);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }

        public void Atualizar(CidadeMODEL cidades)
        {
            try
            {
                CidadeDal = new CidadeDal();
                CidadeDal.Atualizar(cidades);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }

        public CidadeMODEL Pesquisar(string pesquisa)
        {
            var conn = Conexao.Conex();
            try
            {
                var sql = new SqlCommand("SELECT TOP 1 * FROM Cidade WHERE Nome LIKE @Nome", conn);
                sql.Parameters.AddWithValue("@Nome", pesquisa + "%");  // ✅ parâmetro seguro

                conn.Open();
                var datareader = sql.ExecuteReader(CommandBehavior.CloseConnection);

                CidadeMODEL obj_cidade = null;
                if (datareader.Read())
                {
                    obj_cidade = new CidadeMODEL
                    {
                        CidadeID = Convert.ToInt32(datareader["CidadeID"]),
                        Nome = datareader["Nome"].ToString()
                    };
                }
                return obj_cidade;
            }
            catch (Exception erro)
            {
                throw erro;
            }
            finally
            {
                conn.Close();
            }
        }
    }
}
﻿using GVC.DALL;
using GVC.MODEL;
using GVC.MUI;
using System;
using System.Data;
using System.Text.RegularExpressions;

namespace GVC.BLL
{
    internal class  ClienteBLL
    {
        private readonly ClienteDal _dal = new ClienteDal();

        public DataTable Listar()
        {
            try
            {
                return _dal.ListarClientes();
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao carregar clientes: {ex.Message}", ex);
            }
        }

        public void Salvar(ClienteMODEL cliente)
        {
            try
            {
                ValidarCliente(cliente, isNovo: true);

                var cpfLimpo = Utilitario.ApenasNumeros(cliente.Cpf);
                var cnpjLimpo = Utilitario.ApenasNumeros(cliente.Cnpj);

                cliente.Cpf = string.IsNullOrWhiteSpace(cpfLimpo) ? null : cpfLimpo;
                cliente.Cnpj = string.IsNullOrWhiteSpace(cnpjLimpo) ? null : cnpjLimpo;

                if (_dal.ClienteExiste(cliente.Nome, cliente.Cpf))
                    throw new Exception("Já existe um cliente cadastrado com este nome ou CPF.");

                if (_dal.BuscarPorCpf(cliente.Cpf) != null)
                    throw new Exception("Já existe um cliente cadastrado com este CPF.");

                if (_dal.BuscarPorCnpj(cliente.Cnpj) != null)
                    throw new Exception("Já existe um cliente cadastrado com este CNPJ.");

                cliente.DataCriacao = DateTime.Now;
                cliente.UsuarioCriacao = FrmLogin.UsuarioConectado;

                _dal.SalvarCliente(cliente);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao salvar cliente: {ex.Message}", ex);
            }
        }

        public void Alterar(ClienteMODEL cliente)
        {
            try
            {
                if (cliente.ClienteID <= 0)
                    throw new Exception("Cliente inválido para alteração.");

                ValidarCliente(cliente, isNovo: false);

                var cpfLimpo = LimparCpf(cliente.Cpf);
                var existente = _dal.BuscarPorCpf(cpfLimpo);

                if (existente != null && existente.ClienteID != cliente.ClienteID)
                    throw new Exception("Outro cliente já está cadastrado com este CPF.");

                cliente.DataAtualizacao = DateTime.Now;

                _dal.Atualizar(cliente);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao alterar cliente: {ex.Message}", ex);
            }
        }

        public void Excluir(int clienteId)
        {
            try
            {
                if (clienteId <= 0) throw new Exception("ID do cliente inválido.");
                _dal.ExcluirCliente(clienteId);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao excluir cliente: {ex.Message}", ex);
            }
        }

        public void Excluir(ClienteMODEL cliente) => Excluir(cliente.ClienteID);

        public DataTable PesquisarPorNome(string nome)
        {
            try
            {
                return string.IsNullOrWhiteSpace(nome) ? Listar() : _dal.PesquisarPorNome(nome);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro na pesquisa por nome: {ex.Message}", ex);
            }
        }

        public DataTable PesquisarPorCodigo(int codigo)
        {
            try
            {
                return _dal.PesquisarPorCodigo(codigo);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro na pesquisa por código: {ex.Message}", ex);
            }
        }

        public DataTable PesquisarGeral(string texto)
        {
            try
            {
                return _dal.PesquisarGeral(texto);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro na pesquisa geral: {ex.Message}", ex);
            }
        }

        public ClienteMODEL? BuscarPorCpf(string cpf)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(cpf)) return null;

                cpf = LimparCpf(cpf);
                if (!Utilitario.ValidarCPF(cpf))
                    throw new Exception("CPF inválido.");

                return _dal.BuscarPorCpf(cpf);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao buscar cliente por CPF: {ex.Message}", ex);
            }
        }

        public ClienteMODEL? BuscarPorId(int id)
        {
            try
            {
                if (id <= 0) return null;
                return _dal.BuscarPorId(id);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao buscar cliente por ID: {ex.Message}", ex);
            }
        }

        private void ValidarCliente(ClienteMODEL cliente, bool isNovo)
        {
            if (string.IsNullOrWhiteSpace(cliente.Nome))
                throw new Exception("Nome do cliente é obrigatório.");

            // Validação específica por tipo
            if (cliente.TipoCliente == "Jurídica")
            {
                // Pessoa Jurídica: valida CNPJ (apenas se preenchido)
                if (!string.IsNullOrEmpty(cliente.Cnpj))
                {
                    if (cliente.Cnpj.Length != 14)
                        throw new Exception("CNPJ deve conter 14 dígitos.");

                    if (!Utilitario.ValidarCNPJ(cliente.Cnpj))
                        throw new Exception("CNPJ inválido.");
                }

                // Para PJ, CPF deve ser NULL ou vazio
                if (!string.IsNullOrEmpty(cliente.Cpf))
                {
                    // Se tiver CPF, verifica se não é um CPF válido (pode ser digitado por engano)
                    if (cliente.Cpf.Length == 11 && Utilitario.ValidarCPF(cliente.Cpf))
                        throw new Exception("Para Pessoa Jurídica, não é permitido informar CPF.");
                }
            }
            else // Pessoa Física ou outros tipos que usam CPF
            {
                // Pessoa Física: valida CPF (apenas se preenchido)
                if (!string.IsNullOrEmpty(cliente.Cpf))
                {
                    if (cliente.Cpf.Length != 11)
                        throw new Exception("CPF deve conter 11 dígitos.");

                    if (!Utilitario.ValidarCPF(cliente.Cpf))
                        throw new Exception("CPF inválido.");
                }

                // Para PF, CNPJ deve ser NULL ou vazio
                if (!string.IsNullOrEmpty(cliente.Cnpj))
                {
                    // Se tiver CNPJ, verifica se não é um CNPJ válido (pode ser digitado por engano)
                    if (cliente.Cnpj.Length == 14 && Utilitario.ValidarCNPJ(cliente.Cnpj))
                        throw new Exception("Para Pessoa Física, não é permitido informar CNPJ.");
                }
            }

            // Validação de e-mail (se preenchido)
            if (!string.IsNullOrWhiteSpace(cliente.Email) && !IsValidEmail(cliente.Email))
                throw new Exception("E-mail inválido.");

            // Validação de telefone (se preenchido)
            if (!string.IsNullOrWhiteSpace(cliente.Telefone))
            {
                if (cliente.Telefone.Length < 10 || cliente.Telefone.Length > 11)
                    throw new Exception("Telefone deve conter 10 ou 11 dígitos.");
            }

            // Validação de CEP (se preenchido)
            if (!string.IsNullOrWhiteSpace(cliente.Cep))
            {
                if (cliente.Cep.Length != 8)
                    throw new Exception("CEP deve conter 8 dígitos.");
            }
        }

        private static string LimparCpf(string cpf) => Regex.Replace(cpf ?? "", @"\D", "");
        private static string LimparCnpj(string cnpj) => Regex.Replace(cnpj ?? "", @"\D", "");
        private static bool IsValidEmail(string email)
        {
            try
            {
                var addr = new System.Net.Mail.MailAddress(email);
                return addr.Address == email;
            }
            catch
            {
                return false;
            }
        }
    }
}
﻿using GVC.MODEL;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.BLL
{
    
    public class EmpresaBLL
    {
        private readonly EmpresaDal _empresaDal;
        public void Cadastrar(EmpresaModel empresa)
        {
            empresa.Status = 1; // sempre ativo ao inserir
            empresa.DataCriacao = DateTime.Now;
            _empresaDal.Inserir(empresa);
        }

    }
}
﻿using GVC.DALL;
using GVC.MODEL;
using System;
using Microsoft.Data.SqlClient;
using System.Data;

namespace GVC.BLL
{
    internal class EstadoBLL
    {
        EstadoDal estadoDal = null;

        public DataTable Listar()
        {
            try
            {
                estadoDal = new EstadoDal();
                return estadoDal.Listar();
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }

        public void Salvar(EstadoMODEL estado)
        {
            try
            {
                estadoDal = new EstadoDal();
                estadoDal.Salvar(estado);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }

        public void Excluir(EstadoMODEL estado)
        {
            try
            {
                estadoDal = new EstadoDal();
                estadoDal.Excluir(estado);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }

        public void Atualizar(EstadoMODEL estado)
        {
            try
            {
                estadoDal = new EstadoDal();
                estadoDal.Atualizar(estado);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }

        public EstadoMODEL Pesquisar(string pesquisa)
        {
            using var conn = GVC.Helpers.Conexao.Conex();
            try
            {
                var sql = new SqlCommand(
                    "SELECT TOP 1 EstadoID, CodigoUf, Nome, Uf FROM Estado WHERE Nome LIKE @Nome", conn);
                sql.Parameters.AddWithValue("@Nome", pesquisa + "%");  // ✅ parâmetro seguro

                conn.Open();
                var datareader = sql.ExecuteReader(CommandBehavior.CloseConnection);

                EstadoMODEL obj_estado = null;
                if (datareader.Read())
                {
                    obj_estado = new EstadoMODEL
                    {
                        EstadoID = Convert.ToInt32(datareader["EstadoID"]),
                        Nome = datareader["Nome"].ToString(),
                        UF = datareader["Uf"].ToString()
                    };
                }
                return obj_estado;
            }
            catch (Exception erro)
            {
                throw erro;
            }
            finally
            {
                conn.Close();
            }
        }
    }
}
﻿using GVC.DAL;
using GVC.Helpers;
using GVC.MODEL;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.BLL
{
    public class EstoqueBLL
    {
        private readonly EstoqueDAL _dal = new EstoqueDAL();

        public void MovimentarEstoque(MovimentacaoEstoqueModel mov)
        {
            using var conn = Conexao.Conex();
            conn.Open();
            using var tran = conn.BeginTransaction();

            try
            {
                int estoqueAtual = _dal.ObterEstoqueAtual(mov.ProdutoID, conn, tran);
                int novoEstoque;

                switch (mov.TipoMovimentacao)
                {
                    case "Entrada":
                        novoEstoque = estoqueAtual + mov.Quantidade;
                        break;

                    case "Saida":
                        if (estoqueAtual < mov.Quantidade)
                            throw new Exception("Estoque insuficiente para saída.");

                        novoEstoque = estoqueAtual - mov.Quantidade;
                        break;

                    case "Ajuste":
                        // Ajuste define o estoque final diretamente
                        novoEstoque = mov.Quantidade;
                        break;

                    default:
                        throw new Exception("Tipo de movimentação inválido.");
                }

                _dal.AtualizarEstoque(mov.ProdutoID, novoEstoque, conn, tran);

                mov.EstoqueAnterior = estoqueAtual;
                mov.EstoqueAtual = novoEstoque;

                _dal.RegistrarMovimentacao(mov, conn, tran);

                tran.Commit();
            }
            catch
            {
                tran.Rollback();
                throw;
            }
        }
    }
}
﻿using GVC.DALL;
using GVC.MODEL;
using GVC.MUI;
using System;
using System.Data;
using System.Text.RegularExpressions;

namespace GVC.BLL
{
    internal class FornecedorBll
    {
        private readonly FornecedorDal _dal = new FornecedorDal();

        public DataTable Listar()
        {
            try
            {
                return _dal.ListarFornecedores();
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao carregar fornecedores: {ex.Message}", ex);
            }
        }

        public void Salvar(FornecedorModel fornecedor)
        {
            try
            {
                ValidarFornecedor(fornecedor, isNovo: true);

                var cnpjLimpo = LimparCnpj(fornecedor.Cnpj);
                fornecedor.Cnpj = string.IsNullOrWhiteSpace(cnpjLimpo) ? null : cnpjLimpo;

                if (_dal.FornecedorExiste(fornecedor.Nome, fornecedor.Cnpj))
                    throw new Exception("Já existe um fornecedor cadastrado com este nome ou CNPJ.");

                if (_dal.BuscarPorCnpj(fornecedor.Cnpj) != null)
                    throw new Exception("Já existe um fornecedor cadastrado com este CNPJ.");

                fornecedor.DataCriacao = DateTime.Now;

                _dal.SalvarFornecedor(fornecedor);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao salvar fornecedor: {ex.Message}", ex);
            }
        }

        public void Alterar(FornecedorModel fornecedor)
        {
            try
            {
                if (fornecedor.FornecedorID <= 0)
                    throw new Exception("Fornecedor inválido para alteração.");

                ValidarFornecedor(fornecedor, isNovo: false);

                var cnpjLimpo = LimparCnpj(fornecedor.Cnpj);
                var existente = _dal.BuscarPorCnpj(cnpjLimpo);

                if (existente != null && existente.FornecedorID != fornecedor.FornecedorID)
                    throw new Exception("Outro fornecedor já está cadastrado com este CNPJ.");

                // Atualiza auditoria
                fornecedor.DataCriacao = DateTime.Now;

                if (string.IsNullOrWhiteSpace(fornecedor.Telefone)) fornecedor.Telefone = null;
                _dal.Atualizar(fornecedor);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao alterar fornecedor: {ex.Message}", ex);
            }
        }

        public void Excluir(int fornecedorId)
        {
            try
            {
                if (fornecedorId <= 0) throw new Exception("ID do fornecedor inválido.");
                _dal.ExcluirFornecedor(fornecedorId);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao excluir fornecedor: {ex.Message}", ex);
            }
        }

        public void Excluir(FornecedorModel fornecedor) => Excluir((int)fornecedor.FornecedorID);

        public DataTable PesquisarPorNome(string nome)
        {
            try
            {
                return string.IsNullOrWhiteSpace(nome) ? Listar() : _dal.PesquisarPorNome(nome);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro na pesquisa por nome: {ex.Message}", ex);
            }
        }

        public DataTable PesquisarPorCodigo(int codigo)
        {
            try
            {
                return _dal.PesquisarPorCodigo(codigo);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro na pesquisa por código: {ex.Message}", ex);
            }
        }

        public DataTable PesquisarGeral(string texto)
        {
            try
            {
                return _dal.PesquisarGeral(texto);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro na pesquisa geral: {ex.Message}", ex);
            }
        }

        public FornecedorModel? BuscarPorCnpj(string cnpj)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(cnpj)) return null;

                cnpj = LimparCnpj(cnpj);
                if (!Utilitario.ValidarCNPJ(cnpj))
                    throw new Exception("CNPJ inválido.");

                return _dal.BuscarPorCnpj(cnpj);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao buscar fornecedor por CNPJ: {ex.Message}", ex);
            }
        }

        public FornecedorModel? BuscarPorId(int id)
        {
            try
            {
                if (id <= 0) return null;
                return _dal.BuscarPorId(id);
            }
            catch (Exception ex)
            {
                throw new Exception($"Erro ao buscar fornecedor por ID: {ex.Message}", ex);
            }
        }

        private void ValidarFornecedor(FornecedorModel f, bool isNovo)
        {
            if (f == null) throw new ArgumentNullException(nameof(f));

            if (string.IsNullOrWhiteSpace(f.Nome))
                throw new Exception("Nome do fornecedor é obrigatório.");

            if (!string.IsNullOrWhiteSpace(f.Email) && !IsValidEmail(f.Email))
                throw new Exception("E-mail inválido.");

            if (f.CidadeID <= 0)
                throw new Exception("Cidade é obrigatória.");

            if (string.IsNullOrWhiteSpace(f.Logradouro))
                throw new Exception("Logradouro é obrigatório.");

            if (string.IsNullOrWhiteSpace(f.Numero))
                throw new Exception("Número é obrigatório.");

            if (string.IsNullOrWhiteSpace(f.Bairro))
                throw new Exception("Bairro é obrigatório.");

            if (string.IsNullOrWhiteSpace(f.Cep))
                throw new Exception("CEP é obrigatório.");

            if (f.Cep.Length < 8 || !Regex.IsMatch(f.Cep, @"^\d{8}$"))
                throw new Exception("CEP deve conter 8 dígitos numéricos.");

            string cnpj = Utilitario.ApenasNumeros(f.Cnpj);
            if (!string.IsNullOrWhiteSpace(cnpj))
            {
                if (cnpj.Length != 14 || !Utilitario.ValidarCNPJ(cnpj))
                    throw new Exception("CNPJ inválido. Verifique os dígitos.");
            }
        }
        private static string LimparCnpj(string cnpj) => Regex.Replace(cnpj ?? "", @"\D", "");
        private static bool IsValidEmail(string email)
        {
            try
            {
                var addr = new System.Net.Mail.MailAddress(email);
                return addr.Address == email;
            }
            catch
            {
                return false;
            }
        }
    }
}
﻿using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.BLL
{
    internal class HistoricoPrecoBLL
    {
        public int HistoricoID { get; set; }
        public int ProdutoID { get; set; }
        public DateTime DataRegistro { get; set; }
        public decimal PrecoCusto { get; set; }
        public decimal Lucro { get; set; }
        public decimal PrecoVenda { get; set; }

    }
}
﻿using GVC.MODEL;
using System;
using System.Collections.Generic;
using Microsoft.Data.SqlClient;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using GVC.DALL;

namespace GVC.BLL
{
    internal class ItensVendaBLL
    {
        ItemVendaDal itensvendasdall = null;    
        public DataTable Listar()
        {
            DataTable dtable = new DataTable();
            try
            {
                //itensvendasdall = new ItemVendaDAL();
                //dtable = itensvendasdall.listaItensVenda();
            }
            catch (Exception erro)
            {
                throw erro;
            }
            return dtable;
        }
        public void Salvar(ItemVendaModel itensvenda)
        {
            try
            {
                //itensvendasdall = new ItemVendaDAL();
                //itensvendasdall.SalvarItensVenda(itensvenda);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }
        public void Excluir(ItemVendaModel itensvenda)
        {
            try
            {
                itensvendasdall = new ItemVendaDal();
                itensvendasdall.Excluir(itensvenda);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }
        public void Atualizar(ItemVendaModel itensvenda)
        {
            try
            {
                //itensvendasdall = new ItemVendaDAL();
                //itensvendasdall.atualizaItensVenda(itensvenda);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }

        public ItemVendaModel PesquisaItemVenda(string pesquisa)
        {
            using var conn = GVC.Helpers.Conexao.Conex();
            try
            {
                SqlCommand sql = new SqlCommand("SELECT * FROM ItemVenda WHERE ItemVendaID like @Pesquisa + '%'", conn);
                sql.Parameters.AddWithValue("@Pesquisa", pesquisa);

                conn.Open();
                SqlDataReader datareader;
                ItemVendaModel obj_Itensvenda = new ItemVendaModel();
                datareader = sql.ExecuteReader(CommandBehavior.CloseConnection);

                while (datareader.Read())
                {
                    int ItemVendaID = 0;
                    if (int.TryParse(datareader["ItemVendaID"].ToString(), out ItemVendaID))
                    {
                        obj_Itensvenda.ItemVendaID = ItemVendaID;
                    }
                    else
                    {
                        throw new Exception("Falha ao converter ItemVendaID para int.");
                    }
                }
                return obj_Itensvenda;
            }
            catch (Exception erro)
            {
                throw erro;
            }
            finally
            {
                conn.Close();
            }
        }       
        public List<ItemVendaModel> ListarItensPorVenda(long vendaId)
        {
            var dal = new ItemVendaDal();
            return dal.ListarItensPorVenda(vendaId);
        }
    }
}
﻿using GVC.DAL;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.BLL
{
    public class MovimentacaoEstoqueBLL
    {
        private readonly MovimentacaoEstoqueDAL dal = new();

        public DataTable ConsultarMovimentacoes(
            int? produtoId,
            string tipo,
            string origem,
            DateTime inicio,
            DateTime fim)
        {
            return dal.Consultar(produtoId, tipo, origem, inicio, fim);
        }
    }

}
﻿using GVC.DALL;
using GVC.MODEL;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.BLL
{
    internal class PagamentoParcialBll
    {
        private PagamentoParcialDal _dal;

        PagamentoParcialDal pagamentoParcialDAL = null;
        public void Excluir(PagamentoParcialModel pagamentoParcial)
        {
            try
            {
                pagamentoParcialDAL = new PagamentoParcialDal();
                pagamentoParcialDAL.Excluir(pagamentoParcial);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }
        public PagamentoParcialBll()
        {
            _dal = new PagamentoParcialDal();
        }


        public void RegistrarPagamentoParcial(PagamentoParcialModel pagamentoParcial)
        {
            // Lógica de negócios antes de inserir o pagamento parcial, se necessário
            _dal.InserirPagamentoParcial(pagamentoParcial);
        }

        public List<PagamentoParcialModel> ObterPagamentosParciaisPorParcela(int parcelaID)
        {
            // Lógica de negócios antes de obter os pagamentos parciais, se necessário
            return _dal.ObterPagamentosParciaisPorParcela(parcelaID);
        }
    }
}
﻿using Dapper;
using GVC.DALL;
using GVC.MODEL;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using static GVC.View.FrmVendas;

namespace GVC.BLL
{
    internal class ParcelaBLL
    {
        private readonly ParcelaDal _parcelaDal;
        private readonly VendaDal _vendaDal = new VendaDal();
        private readonly VendaBLL _vendaBLL;
        public ParcelaBLL()
        {
            _parcelaDal = new ParcelaDal();
            _vendaDal = new VendaDal();
            _vendaBLL = new VendaBLL();
        }

        // ==========================================================
        // 1. BAIXA TOTAL DE UMA PARCELA (força pagamento completo)
        // ==========================================================
        public void BaixarParcelaTotal(long parcelaId)
        {
            var parcela = _parcelaDal.BuscarPorId(parcelaId)
                ?? throw new Exception("Parcela não encontrada.");

            // Calcular o saldo restante em decimal
            decimal totalDevido = (parcela.ValorParcela + parcela.Juros + parcela.Multa);
            decimal valorRecebido = parcela.ValorRecebido;
            decimal saldoRestante = totalDevido - valorRecebido;

            if (saldoRestante <= 0)
                return; // Já está quitada

            // Arredondar para evitar problemas de precisão
            saldoRestante = Math.Round(saldoRestante, 2, MidpointRounding.AwayFromZero);

            // Inserir pagamento do saldo restante
            _parcelaDal.BaixarParcela(parcelaId, saldoRestante, DateTime.Now);
        }

        // ==========================================================
        // 2. BAIXA PARCIAL DE UMA PARCELA (valor informado pelo usuário)
        // ==========================================================
        public void BaixarParcelaParcial(long parcelaId, decimal valorPago)
        {
            if (valorPago <= 0m)
                throw new Exception("O valor pago deve ser maior que zero.");

            var parcela = _parcelaDal.BuscarPorId(parcelaId)
                ?? throw new Exception("Parcela não encontrada.");

            decimal totalDevido = parcela.ValorParcela + parcela.Juros + parcela.Multa;
            decimal saldoAtual = totalDevido - parcela.ValorRecebido;

            valorPago = Math.Round(valorPago, 2, MidpointRounding.AwayFromZero);

            if (valorPago > saldoAtual)
                throw new Exception("Valor pago maior que o saldo devido.");

            // 1️⃣ Baixa da parcela
            _parcelaDal.BaixarParcela(parcelaId, valorPago, DateTime.Now);

            // 2️⃣ Buscar TODAS as parcelas da venda
            var parcelasVenda = _parcelaDal.GetParcelas((int)parcela.VendaID);

            // 3️⃣ Recalcular status da venda (STATUS DE NEGÓCIO)
            string statusCalculado =
                _vendaBLL.CalcularStatusVendaPorParcelas(parcelasVenda);

            // 🔥 3.1️⃣ AJUSTE PARA STATUS ACEITO PELO BANCO
            string statusParaBanco = statusCalculado switch
            {
                var s when s == EnumStatusVenda.ParcialmentePago.ToDb()
                    => EnumStatusVenda.AguardandoPagamento.ToDb(),

                var s when s == EnumStatusVenda.EmAnalise.ToDb()
                    => EnumStatusVenda.AguardandoPagamento.ToDb(),

                _ => statusCalculado
            };

            // 4️⃣ Atualizar venda (SOMENTE status válido)
            _vendaDal.AtualizarStatusVenda(parcela.VendaID, statusParaBanco);
        }



        // ==========================================================
        // 3. BAIXA EM LOTE (várias parcelas selecionadas no grid)
        // ==========================================================
        public void BaixarParcelasEmLote(List<int> parcelasIds)
        {
            if (parcelasIds == null || parcelasIds.Count == 0)
                throw new Exception("Nenhuma parcela selecionada.");

            BaixarParcelasEmLote(parcelasIds.Select(id => (long)id).ToList());
        }

        public void BaixarParcelasEmLote(List<long> parcelasIds)
        {
            if (parcelasIds == null || parcelasIds.Count == 0)
                throw new Exception("Nenhuma parcela selecionada para baixa.");

            // 1️⃣ Descobrir a venda (todas são da mesma venda no grid)
            var primeiraParcela = _parcelaDal.BuscarPorId(parcelasIds[0])
                ?? throw new Exception("Parcela não encontrada.");

            long vendaId = primeiraParcela.VendaID;

            // 2️⃣ Baixa em lote (DAL)
            _parcelaDal.BaixarParcelasEmLote(parcelasIds, DateTime.Now);

            // 3️⃣ Recalcular status da venda UMA ÚNICA VEZ
            var parcelasVenda = _parcelaDal.GetParcelas((int)vendaId);
            string novoStatus = _vendaBLL.CalcularStatusVenda(parcelasVenda);

            _vendaDal.AtualizarStatusVenda(vendaId, novoStatus);
        }


        // ==========================================================
        // ALTERAR STATUS MANUALMENTE
        // ==========================================================
        public void AlterarStatus(int parcelaId, string novoStatus)
        {
            if (string.IsNullOrWhiteSpace(novoStatus))
                throw new Exception("Status inválido.");

            ParcelaModel parcela = _parcelaDal.BuscarPorId(parcelaId)
                ?? throw new Exception("Parcela não encontrada.");

            parcela.Status = novoStatus;
            _parcelaDal.UpdateParcela(parcela);
        }

        // ==========================================================
        // EXCLUSÃO
        // ==========================================================
        public void Excluir(ParcelaModel parcela)
        {
            if (parcela == null)
                throw new Exception("Parcela inválida.");

            _parcelaDal.Excluir(parcela);
        }

        /// <summary>
        /// Estorna um pagamento (parcial ou total) de uma parcela
        /// </summary>
        /// <param name="parcelaId">ID da parcela</param>
        /// <param name="valorEstorno">Valor a estornar (positivo)</param>
        /// <param name="motivo">Motivo do estorno (para auditoria)</param>
        public void EstornarPagamento(long parcelaId, decimal valorEstorno, string motivo)
        {
            if (valorEstorno <= 0)
                throw new Exception("Valor de estorno inválido.");

            var parcela = _parcelaDal.BuscarPorId(parcelaId)
                ?? throw new Exception("Parcela não encontrada.");

            if (valorEstorno > parcela.ValorRecebido)
                throw new Exception("Valor do estorno maior que o valor recebido.");

            _parcelaDal.EstornarPagamento(parcelaId, valorEstorno, DateTime.Now, motivo);

            // 🔁 Recalcula venda
            var parcelasVenda = _parcelaDal.GetParcelas((int)parcela.VendaID);
            var statusVenda = _vendaBLL.CalcularStatusVendaPorParcelas(parcelasVenda);

            if (statusVenda == EnumStatusVenda.ParcialmentePago.ToDb())
                statusVenda = EnumStatusVenda.AguardandoPagamento.ToDb();

            _vendaDal.AtualizarStatusVenda(parcela.VendaID, statusVenda);
        }

        public void EstornarPagamentosEmLote(
     List<long> parcelasIds,
     decimal valorEstorno,
     string motivo)
        {
            if (valorEstorno <= 0)
                throw new Exception("Valor de estorno inválido.");

            decimal valorRestante = valorEstorno;

            foreach (var parcelaId in parcelasIds)
            {
                if (valorRestante <= 0)
                    break;

                var parcela = _parcelaDal.BuscarPorId(parcelaId)
                    ?? throw new Exception("Parcela não encontrada.");

                decimal estornoNestaParcela =
                    Math.Min(parcela.ValorRecebido, valorRestante);

                if (estornoNestaParcela <= 0)
                    continue;

                _parcelaDal.EstornarPagamento(
                    parcelaId,
                    estornoNestaParcela,
                    DateTime.Now,
                    motivo
                );

                valorRestante -= estornoNestaParcela;
            }

            // 🔁 Recalcula status da venda UMA VEZ
            long vendaId = _parcelaDal.BuscarPorId(parcelasIds.First()).VendaID;
            var parcelasVenda = _parcelaDal.GetParcelas((int)vendaId);

            string statusVenda =
                _vendaBLL.CalcularStatusVendaPorParcelas(parcelasVenda);

            // 🔒 CHECK constraint do SQLite
            if (statusVenda == EnumStatusVenda.ParcialmentePago.ToDb())
                statusVenda = EnumStatusVenda.AguardandoPagamento.ToDb();

            _vendaDal.AtualizarStatusVenda(vendaId, statusVenda);
        }
    }
}
﻿// ==================================================
// 3. BLL - ProdutosBLL.cs
// ==================================================
using System.Collections.Generic;
using GVC.MODEL;
using GVC.DAL;

namespace GVC.BLL
{
    public class ProdutosBLL
    {
        private readonly ProdutoDALL _dal = new ProdutoDALL();

        public List<ProdutosModel> ListarTodos() => _dal.ListarTodos();

        public ProdutosModel? BuscarPorId(long id) => _dal.BuscarPorId(id);

        public long Inserir(ProdutosModel produto)
        {
            // Validações básicas de negócio (você pode expandir)
            if (string.IsNullOrWhiteSpace(produto.NomeProduto))
                throw new Exception("Nome do produto é obrigatório.");

            if (produto.PrecoCusto < 0)
                throw new Exception("Preço de custo não pode ser negativo.");

            if (produto.PrecoDeVenda < 0)
                throw new Exception("Preço de venda não pode ser negativo.");

            return _dal.Inserir(produto);
        }

        public bool Alterar(ProdutosModel produto)
        {
            if (produto.ProdutoID <= 0)
                throw new Exception("ID do produto inválido.");

            return _dal.Alterar(produto);
        }

        public bool Excluir(long id)
        {
            if (id <= 0)
                throw new Exception("ID inválido.");

            return _dal.Excluir(id);
        }
    }
}﻿using GVC.DAL;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.BLL
{
    public class RelatorioEstoqueBLL
    {
        private readonly RelatorioEstoqueDAL dal = new();

        public DataTable ObterRelatorioEstoque(
            out decimal totalCusto,
            out decimal totalVenda,
            out decimal totalLucro)
        {
            var dt = dal.ObterRelatorioEstoque();

            totalCusto = 0m;
            totalVenda = 0m;
            totalLucro = 0m;

            foreach (DataRow row in dt.Rows)
            {
                totalCusto += Convert.ToDecimal(row["ValorTotalCusto"]);
                totalVenda += Convert.ToDecimal(row["ValorTotalVenda"]);
                totalLucro += Convert.ToDecimal(row["LucroTotalProduto"]);
            }

            return dt;
        }
    }

}
﻿using GVC.DAL;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.BLL
{
    public class RelatorioGiroEstoqueBLL
    {
        public DataTable ObterGiro(DateTime inicio, DateTime fim)
        {
            return new RelatorioGiroEstoqueDAL().ObterGiro(inicio, fim);
        }
    }
}
﻿using GVC.DAL;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace GVC.BLL
{
    public class RelatorioLucroProdutoBLL
    {
        public DataTable ObterRanking()
        {
            return new RelatorioLucroProdutoDAL().RankingLucro();
        }
    }
}
﻿using GVC.DALL;
using GVC.MODEL;
using System;
using System.Collections.Generic;
using Microsoft.Data.SqlClient;
using System.Data;
using System.Linq;
using System.Text;

using System.Threading.Tasks;
using System.Windows.Forms;

namespace GVC.BLL
{
    internal class UsuarioBLL
    {
        UsuarioDal usuariodal = null;

        public string ObterSenhaHashPorId(int usuarioId)
        {
            string sql = "SELECT Senha FROM Usuarios WHERE UsuarioID = @id";

            using (var conn = GVC.Helpers.Conexao.Conex())
            using (var cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@id", usuarioId);

                conn.Open();
                object result = cmd.ExecuteScalar();
                return result?.ToString(); // retorna a senha como string
            }

        }
        public DataTable Listar()
        {
            DataTable dtable = new DataTable();
            try
            {
                usuariodal = new UsuarioDal();
                dtable = usuariodal.ListaUsuario();
            }
            catch (Exception erro)
            {
                throw erro;
            }
            return dtable;
        }

        public void Salvar(UsuarioMODEL usuarios)
        {
            try
            {
                usuariodal = new UsuarioDal();
                usuariodal.GravaUsuario(usuarios);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }

        public void Excluir(UsuarioMODEL usuarios)
        {
            try
            {
                usuariodal = new UsuarioDal();
                usuariodal.ExcluiUsuario(usuarios);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }
        public void Alterar(UsuarioMODEL usuarios)
        {
            try
            {
                usuariodal = new UsuarioDal();
                usuariodal.Atualizar(usuarios);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }

        public void AtualizaUsuarioDalSenha(UsuarioMODEL usuarios)
        {
            try
            {
                usuariodal = new UsuarioDal();
                usuariodal.AtualizaUsuarioSenha(usuarios);
            }
            catch (Exception erro)
            {
                throw erro;
            }
        }
      
        public UsuarioMODEL PesquisarNo(DataGridView DataGridPesquisa, string pesquisa)
        {
            var conn = GVC.Helpers.Conexao.Conex();
            try
            {
                SqlCommand sql = new SqlCommand("SELECT * FROM Usuarios WHERE NomeUsuario like '" + pesquisa + "%'", conn);
                conn.Open();
                SqlDataReader datareader;
                UsuarioMODEL obj_usuario = new UsuarioMODEL();
                datareader = sql.ExecuteReader(CommandBehavior.CloseConnection);

                while (datareader.Read())
                {
                    obj_usuario.UsuarioID = Convert.ToInt32(datareader["UsuarioID"]);
                    obj_usuario.NomeUsuario = datareader["NomeUsuario"].ToString();
                }
                return obj_usuario;
            }
            catch (Exception erro)
            {
                throw erro;
            }
            finally
            {
                conn.Close();
            }
        }
        public UsuarioMODEL PesquisarCodigo(string pesquisa)
        {
            var conn = GVC.Helpers.Conexao.Conex();
            try
            {
                SqlCommand sql = new SqlCommand("SELECT * FROM Usuarios WHERE UsuarioID like '" + pesquisa + "%'", conn);
                conn.Open();
                SqlDataReader datareader;
                UsuarioMODEL obj_usuario = new UsuarioMODEL();
                datareader = sql.ExecuteReader(CommandBehavior.CloseConnection);

                while (datareader.Read())
                {
                    obj_usuario.UsuarioID = Convert.ToInt32(datareader["UsuarioID"]);
                    obj_usuario.NomeUsuario = datareader["NomeUsuario"].ToString();
                }
                return obj_usuario;
            }
            catch (Exception erro)
            {
                throw erro;
            }
            finally
            {
                conn.Close();
            }
        }
    }
}
﻿using GVC.DAL;
using GVC.DALL;
using GVC.Helpers;
using GVC.MODEL;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using static GVC.View.FrmVendas;

namespace GVC.BLL
{
    internal class VendaBLL
    {
        private readonly VendaDal vendaDAL;
        // ✅ CONSTRUTOR OBRIGATÓRIO
        public VendaBLL()
        {
            vendaDAL = new VendaDal();
        }       
        //🔹 Passo B — Criar método de cálculo na VendaBLL
        public string CalcularStatusVendaPorParcelas(List<ParcelaModel> parcelas)
        {
            if (parcelas == null || parcelas.Count == 0)
                return EnumStatusVenda.Aberta.ToDb();

            decimal total = parcelas.Sum(p => p.ValorParcela + p.Juros + p.Multa);
            decimal recebido = parcelas.Sum(p => p.ValorRecebido);

            if (recebido <= 0)
                return EnumStatusVenda.Aberta.ToDb();

            if (recebido >= total)
                return EnumStatusVenda.Concluida.ToDb();

            return EnumStatusVenda.ParcialmentePago.ToDb();
        }      
        public int SalvarVendaCompleta(VendaModel venda, List<ItemVendaModel> itens, List<ParcelaModel>? parcelas = null)
        {
            if (venda == null)
                throw new ArgumentNullException(nameof(venda));

            if (itens == null || !itens.Any())
                throw new Exception("Adicione pelo menos um item à venda.");

            // ====================
            // REGRAS DE NEGÓCIO - TRATAMENTO SEGURO
            // ====================

            // Desconto da venda: se for nullable (decimal?), trata como 0
            decimal descontoVenda = venda.Desconto ?? 0m;
            if (descontoVenda < 0m) descontoVenda = 0m;

            // ====================
            // ITENS - TRATAMENTO DIFERENCIADO POR CAMPO
            // ====================
            foreach (var item in itens)
            {
                // PrecoUnitario é decimal (não nullable) → já tem valor
                decimal preco = item.PrecoUnitario;

                // DescontoItem é decimal? → usa ?? 0m
                decimal descontoItem = (decimal)item.DescontoItem;
                if (descontoItem < 0m) descontoItem = 0m;

                // Subtotal é decimal? → recalcula sempre com segurança
                decimal subtotalCalculado = (item.Quantidade * preco) - descontoItem;
                if (subtotalCalculado < 0m) subtotalCalculado = 0m;

                // Atualiza os campos
                item.DescontoItem = descontoItem;
                item.Subtotal = subtotalCalculado;
            }

            // ====================
            // TOTAL DOS ITENS
            // ====================
            decimal totalDosItens = (decimal)itens.Sum(i => i.Subtotal);

            // Valor esperado = total itens - desconto venda
            decimal valorEsperado = Math.Max(0m, totalDosItens - descontoVenda);

            // Se ValorTotal da venda for inconsistente, corrige
            if (Math.Abs((venda.ValorTotal) - valorEsperado) > 0.01m)
            {
                venda.ValorTotal = valorEsperado;
            }

            // Atualiza o desconto da venda
            venda.Desconto = descontoVenda;

            // ====================
            // PARCELAS
            // ====================
            if (parcelas != null && parcelas.Any())
            {
                decimal totalParcelas = 0m;

                foreach (var p in parcelas)
                {
                    p.ValorParcela = Math.Max(0m, p.ValorParcela);
                    p.ValorRecebido = Math.Max(0m, p.ValorRecebido);
                    p.Juros        = Math.Max(0m, p.Juros);
                    p.Multa        = Math.Max(0m, p.Multa);

                    totalParcelas += p.ValorParcela + p.Juros + p.Multa;

                    if (p.Status == "Paga" || p.Status == EnumStatusParcela.Paga.ToDb())
                    {
                        if (p.DataPagamento == null)
                            p.DataPagamento = DateTime.Now;
                    }
                }

                if (Math.Abs(totalParcelas - (venda.ValorTotal)) > 0.01m)
                {
                    throw new Exception($"Total parcelas (R$ {totalParcelas:N2}) não bate com valor da venda (R$ {venda.ValorTotal:N2}).");
                }
            }
           
            // ====================
            // SALVA
            // ====================
            return vendaDAL.AddVendaCompleta(venda, itens, parcelas);
        }
        public void ExcluirVenda(int vendaID)
        {
            if (ExistePagamento(vendaID))
                throw new Exception("Não é possível excluir venda com pagamentos.");

            new PagamentosParciaisDal().ExcluirPorVenda(vendaID);
            new ParcelaDal().ExcluirPorVenda(vendaID);
            new ItemVendaDal().ExcluirPorVenda(vendaID);
            new VendaDal().Excluir(vendaID);
        }
        public bool ExistePagamento(long vendaId)
        {
            return new ParcelaDal().ExistePagamentoPorVenda(vendaId);
        }

        public void Alterar(VendaModel venda)
        {
            vendaDAL.UpdateVenda(venda);
        }

       
        // ⚠️ SE PRECISAR MANTER int
        public VendaModel ObterVendaPorId(int vendaId)
        {
            return vendaDAL.ObterVendaPorId(vendaId);
        }

        public string CalcularStatusVenda(List<ParcelaModel> parcelas)
        {
            if (parcelas == null || parcelas.Count == 0)
                return EnumStatusVenda.Aberta.ToDb();

            decimal total = parcelas.Sum(p => p.ValorParcela + p.Juros + p.Multa);
            decimal recebido = parcelas.Sum(p => p.ValorRecebido);

            if (recebido <= 0)
                return EnumStatusVenda.Aberta.ToDb();

            if (recebido >= total)
                return EnumStatusVenda.Concluida.ToDb();

            return EnumStatusVenda.ParcialmentePago.ToDb();
        }
        public void CancelarVenda(long vendaId, string motivo)
        {
            if (string.IsNullOrWhiteSpace(motivo))
                throw new Exception("Motivo do cancelamento é obrigatório.");

            var vendaDal = new VendaDal();
            var itemDal = new ItemVendaDal();
            var produtoDal = new ProdutoDALL();
            var parcelaDal = new ParcelaDal();
            var parcelaBll = new ParcelaBLL();

            using var conn = GVC.Helpers.Conexao.Conex();
            conn.Open();
            using var tran = conn.BeginTransaction();

            try
            {
                // ============================
                // 1️⃣ ESTORNAR PAGAMENTOS
                // ============================
                var parcelas = parcelaDal.GetParcelas((int)vendaId);

                foreach (var p in parcelas)
                {
                    if (p.ValorRecebido > 0)
                    {
                        parcelaBll.EstornarPagamento(
                            p.ParcelaID,
                            p.ValorRecebido,
                            motivo
                        );
                    }
                }

                // ============================
                // 2️⃣ CANCELAR PARCELAS
                // ============================
                parcelaDal.CancelarParcelasPorVenda(vendaId);

                // ============================
                // 3️⃣ DEVOLVER ESTOQUE
                // ============================
                var itens = itemDal.ListarItensPorVenda(vendaId);

                foreach (var item in itens)
                {
                    var produto = produtoDal.BuscarPorId(item.ProdutoID);

                    if (produto == null)
                        throw new Exception($"Produto ID {item.ProdutoID} não encontrado.");

                    produto.Estoque += item.Quantidade;
                    produtoDal.Alterar(produto);
                }

                // ============================
                // 4️⃣ CANCELAR VENDA + MOTIVO
                // ============================
                vendaDal.AtualizarStatusVenda(vendaId,  EnumStatusVenda.Cancelada.ToDb(), motivo );

                tran.Commit();
            }
            catch
            {
                tran.Rollback();
                throw;
            }
        }



        public bool PodeAlterarVenda(int vendaID)
        {
            return !ExistePagamento(vendaID);
        }       
        public void ExcluirVendaFisicamente(long vendaId)
        {
            var parcelaDal = new ParcelaDal();

            if (parcelaDal.ExistePagamentoPorVenda(vendaId))
                throw new Exception( "EXCLUSÃO BLOQUEADA!\n\n" +
                    "Esta venda possui pagamentos registrados.\n" +
                    "Remova os pagamentos antes de tentar excluir.");

            new PagamentosParciaisDal().ExcluirPorVenda(vendaId);
            new ParcelaDal().ExcluirPorVenda(vendaId);
            new ItemVendaDal().ExcluirPorVenda(vendaId);
            new VendaDal().Excluir(vendaId);
        }
        //Abaixo métodos para atualizar venda, 
        public bool VendaPossuiPagamento(long vendaId)
        {
            using var conn = Conexao.Conex();
            conn.Open();

            string sql = @" SELECT COUNT(*)
        FROM PagamentosParciais pp
        INNER JOIN Parcela p ON p.ParcelaID = pp.ParcelaID
        WHERE p.VendaID = @VendaID";

            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@VendaID", vendaId);

            return (int)cmd.ExecuteScalar() > 0;
        }
       
        public VendaCompletaModel ObterVendaCompleta(long vendaId)
        {
            return new VendaConsultaDal().ObterVendaCompleta(vendaId);
        }

        public void AtualizarVendaCompleta( VendaModel venda, List<ItemVendaModel> itens,  List<ParcelaModel> parcelas)
        {
            if (venda == null)
                throw new ArgumentNullException(nameof(venda));

            if (itens == null || !itens.Any())
                throw new Exception("A venda deve possuir ao menos um item.");

            if (ExistePagamento(venda.VendaID))
                throw new Exception(
                    "Não é possível alterar a venda.\n\n" +
                    "Existem pagamentos registrados.");

            // 🔹 Recalcula status da venda
            venda.StatusVenda = CalcularStatusVenda(parcelas);

            // 🔹 Chama DAL (igual salvar)
            new VendaAtualizacaoDal()
                .AtualizarVendaCompleta(venda, itens, parcelas);
        }
    }
}
